<!--
    SPDX-FileCopyrightText: Copyright Â© 2025 Idiap Research Institute <contact@idiap.ch>

    SPDX-FileContributor: Philip Abbet <philip.abbet@idiap.ch>

    SPDX-License-Identifier: MPL-2.0
-->

<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">

        <link rel="stylesheet" href="https://pyscript.net/releases/2024.8.2/core.css">
        <script type="module" src="https://pyscript.net/releases/2024.8.2/core.js"></script>
        <script src="../mini-coi.js"></script>

        <link rel="stylesheet" href="../css/loader.css"/>

        <style>
            div#container {
                display: flex;
            }

            div.py-editor-input {
                border: 1px solid #202020;
            }
        </style>
    </head>

    <body style="font-family: monospace;">
        <h2>Geometric primitives</h2>

        <div id="loader-container">
            <span class="loader"></span>
        </div>

        <div id="container" style="display: none;">
            <div id="editor"></div>
            <div id="output" style="padding-left: 40px; padding-top: 2em;"></div>
        </div>

        <script type="py-editor" env="demo_env" setup
                config='{"packages":["numpy", "matplotlib"]}'
        >
            from pyscript import document
            from pyscript import display

            def print(*args):
                display(*args, target="output")

            document.getElementById('loader-container').style.display = 'none'
            document.getElementById('container').style.display = 'flex'

            def handle_event(event):
                document.getElementById('output').textContent = ''
                return True

            user_editor = document.getElementById("user_editor")
            user_editor.handleEvent = handle_event
            
            # Download the pygafro wheel
            import micropip
            parts = document.location.pathname.split('/')
            url = document.location.origin + '/'.join(parts[:-2]) + '/wasm/pygafro-1.3.0-cp312-cp312-pyodide_2024_0_wasm32.whl'
            await micropip.install(url)
        </script>

        <script id="user_editor" type="py-editor" env="demo_env" target="editor">
            from pygafro import FrankaEmikaRobot
            import numpy as np


            panda = FrankaEmikaRobot()

            position = panda.getRandomConfiguration()
            velocity = np.random.random((7,))
            acceleration = np.random.random((7,))
            torque = np.random.random((7,))

            # forward kinematics: compute the motor at the end-effector
            ee_motor = panda.getEEMotor(position)

            print(f'ee_motor = {ee_motor}')

            # compute jacobians
            ee_analytic_jacobian = panda.getEEAnalyticJacobian(position)
            ee_geometric_jacobian = panda.getEEGeometricJacobian(position)

            print('------')
            print('Analytic Jacobian:')
            for i, v in enumerate(ee_analytic_jacobian):
                print(f'{i}: {v}')

            print('------')
            print('Geometric Jacobian:')
            for i, v in enumerate(ee_geometric_jacobian):
                print(f'{i}: {v}')

            # compute dynamics
            acceleration_computed = panda.getJointAccelerations(position, velocity, torque)

            torque_computed = panda.getJointTorques(position, velocity, acceleration)

            print('------')
            print(f'acceleration_computed = {acceleration_computed.transpose()}')
            print(f'torque_computed = {torque_computed.transpose()}')
        </script>
    </body>
</html>
