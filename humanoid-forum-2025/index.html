<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Tutorial at International Humanoid Forum 2025</title>

    <link href="../css/permanent_marker.css" rel="stylesheet">
    <link rel="stylesheet" href="reveal/reset.css">
    <link rel="stylesheet" href="reveal/reveal.css">
    <link rel="stylesheet" href="reveal/theme/white.css">
    <link href="../css/katex.min.css" rel="stylesheet">
    <link href="https://pyscript.net/releases/2024.8.2/core.css" rel="stylesheet">
    <link href="../css/loader.css" rel="stylesheet"/>

    <!-- Theme used for syntax highlighted code -->
    <!-- <link rel="stylesheet" href="plugin/highlight/monokai.css"> -->

    <py-config type="toml">
        packages = ['numpy']
        terminal = false
        [[fetch]]
            from = '../viewer3d/'
            files = ['viewer3d.py']
    </py-config>

    <!-- <script type="module" src="https://pyscript.net/releases/2024.8.2/core.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/reveal.js-plugins@latest/loadcontent/plugin.js"></script>
    <script src="../js/editor.bundle.js"></script>
    <script src="../js/katex.min.js"></script>
    <script src="../js/katex-auto-render.js"></script>
    <script src="../js/glslrenderer.js"></script>

    <!-- Import all the necessary JavaScript dependency modules -->
    <script src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
                "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/",
                "mujoco": "../viewer3d/jsm/mujoco_wasm.js",
                "katex": "https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.mjs",
                "mathjs": "https://cdn.jsdelivr.net/npm/mathjs@12.0.0/+esm"
            }
        }
    </script>

    <script type="module" src="../3d_sandboxes/postprocessing/sdfpass.js"></script>

    <style title="custom">
        .python-editor {
            box-sizing: border-box;
            font-size: 12px;
            text-align: initial;
            display: flex;
            width: 100%;
            max-height: 100%;
        }

        .python-editor .cm-editor {
            background-color: #EEEEEE;
            width: 100%;
        }

        .py-output {
            font-size: 14px !important;
            max-height: 100em;
            color: rgb(33, 37, 41);
            padding: 0.5rem;
            overflow: auto;
            border: 1px solid #DDDDDD;
        }

        .py-output:empty {
            display: none;
        }

        .py-error {
            border: 1px solid red;
            background: rgb(255, 221, 221);
            color: black;
            font-family: courier, monospace;
            font-size: 14px !important;
            white-space: pre;
            overflow-x: auto;
            padding: 8px;
            margin-top: 8px;
        }

        .py-error:empty {
            display: none;
        }

        .reveal .slides section > section {
            top: 0 !important;
            height: 100%;
        }

        #loader-container {
            position: absolute;
            right: 0;
            z-index: 1000;
        }
    </style>
</head>


<body>
    <div id="loader-container">
        <span class="loader"></span>
    </div>

    <div class="reveal">
        <div class="slides">
        
            <section data-background="images/chalkboard01.jpg">
                <br><br><br><br>
                <h1 style="color: #eee; opacity: 0.8;">Tutorial on Programming Humanoid Robots</h1>
                <br>
                <h6 style="color: #aaa; opacity: 0.8;">International Humanoid Forum â€” February 21, 2025</h6>
                <br><br><br><br>
                <h2 style="color: #eee; opacity: 0.8;">Sylvain Calinon</h2>
                <h3 style="color: #eee; opacity: 0.8;">Idiap Research Institute</h3>
            </section>
            
            <section data-transition="zoom">
                <img src="images/RCFSwithContributors01.jpg" class="r-stretch">
            </section>
            
            <!--
            <section data-transition="convex">
                <p class="r-fit-text">https://rcfs.ch/humanoid-forum-2025/</p>
                <img class="r-stretch" src="images/qrcode01.png">
            </section>
            -->
            
            <section data-transition="convex">
                <img src="images/Idiap01.jpg" class="r-stretch">
            </section>
            
            <section data-load="humanoid3d_1.html" data-code="humanoid3d_1"></section>
            <section data-load="humanoid3d_2.html" data-code="humanoid3d_2"></section>
            
            <section data-transition="convex">
                <h2>Why is it hard to program a humanoid robot?</h2>
                <img src="images/whyisroboticshard01.jpg" class="r-stretch">
            </section>
            
            <section>
                <h2>Forward kinematics</h2>
                <img src="images/FK01.png" class="r-stretch">
            </section>
            
            <!--
            <section>
                <h6>Stack Example</h6>
                <div class="r-stack">
                    <p class="fragment fade-in-then-out">One</p>
                    <p class="fragment fade-in-then-out">Two</p>
                    <p class="fragment fade-in-then-out">Three</p>
                    <p class="fragment fade-in-then-out">Four</p>
                </div>
                <div class="r-stack">
                    <img src="https://placekittens.com/g/450/300" width="450" height="300" class="fragment">
                    <img src="https://placekittens.com/g/300/450" width="300" height="450" class="fragment">
                    <img src="https://placekittens.com/g/400/400" width="400" height="400" class="fragment">
                </div>
            </section>
            -->
            
            <section data-load="fk2d.html" data-code="fk2d"></section>
            <section data-load="jacobian2d.html" data-code="jacobian2d"></section>
            <section data-load="jacobian3d.html" data-code="jacobian3d"></section>
            
            <section>
		        <section>
		            <h2>Inverse kinematics (IK)</h2>
		            <div style="display: inline-block; width: 69%; vertical-align: top;">
				        <div class="r-fit-text">
				        \begin{align*}
				            \qquad \bm{\dot{x}} &= \arg\min_{\bm{\dot{x}}} \; \|\bm{J}\bm{\dot{x}}-\bm{\dot{f}}\|^2 \qquad \\
				            &= \underbrace{{(\bm{J}^\trsp \bm{J})}^{-1} \bm{J}^\trsp}_{\color{red}\bm{J}^\psin} \; \bm{\dot{f}}
				        \end{align*}
				        </div>
		            </div>
		            <div style="display: inline-block; width: 29%;">
		            	<img src="images/FK_dF01.png">
		            </div>
		        </section>
		        
		        <section data-transition="zoom-in fade-out">
		            <h2><span style="color:red">Damped</span> inverse kinematics</h2>
		            <div class="r-fit-text">
		            \begin{align*}
		                \bm{\dot{x}} &= \arg\min_{\bm{\dot{x}}} \; \|\bm{J}\bm{\dot{x}}-\bm{\dot{f}}\|^2 + {\color{red} \lambda \|\bm{\dot{x}}\|^2} \\
		                &= {(\bm{J}^\trsp \bm{J} + {\color{red} \lambda\bm{I}})}^{-1} \bm{J}^\trsp \; \bm{\dot{f}}
		            \end{align*}
		            </div>
		        </section>
		        
		        <section data-transition="zoom-in fade-out">
		            <h2><span style="color:red">Weighted</span> inverse kinematics</h2>
		            <div class="r-fit-text">
		            \begin{align*}
		                \bm{\dot{x}} &= \arg\min_{\bm{\dot{x}}} \; \|\bm{J}\bm{\dot{x}}-\bm{\dot{f}}\|^2_{{\color{red}\bm{W}}} \\
		                &= (\bm{J}^\trsp {\color{red}\bm{W}} \bm{J})^{-1} \bm{J}^\trsp {\color{red}\bm{W}} \; \bm{\dot{f}}
		            \end{align*}
		            </div>
		        </section>
		        
		        <section data-transition="zoom-in fade-out">
		            <h2><span style="color:red">Prioritized</span> inverse kinematics</h2>
		            <div class="r-fit-text">
		            \begin{align*}
		                \bm{\dot{x}} &= \arg\min_{\bm{\dot{x}}} \; {\color{red}c(\bm{x})} \quad\text{s.t.}\quad \bm{\dot{f}}=\bm{J}\bm{\dot{x}} \\
		                &= \bm{J}^\psin\!(\bm{x}) \; \bm{\dot{f}} {\color{red} \;+\; \bm{N}\!(\bm{x}) \; \frac{\partial c(\bm{x})}{\partial\bm{x}}}
		            \end{align*}
		            </div>
		        </section>
            </section>
            
            <!--
            <section>
                <section>
                    <h2>Inverse kinematics (IK)</h2>
                    <div>
                    <div class="hv-center">
                    \begin{align*}
                        \bm{\dot{x}} &= \arg\min_{\bm{\dot{x}}} \; \|\bm{J}\bm{\dot{x}}-\bm{\dot{f}}\|^2 \\
                        &= {(\bm{J}^\trsp \bm{J})}^{-1} \bm{J}^\trsp \bm{\dot{f}}
                    \end{align*}
                    </div>
                    </div>
                </section>          
                <section>
                    <h2>Damped inverse kinematics</h2>
                    <br>
                    <div class="r-fit-text">
                    \begin{align*}
                        \bm{\dot{x}} &= \arg\min_{\bm{\dot{x}}} \; \|\bm{J}\bm{\dot{x}}-\bm{\dot{f}}\|^2 + {\color{red} \lambda \|\bm{\dot{x}}\|^2} \\
                        &= {(\bm{J}^\trsp \bm{J} + {\color{red} \lambda\bm{I}})}^{-1} \bm{J}^\trsp \bm{\dot{f}}
                    \end{align*}
                    </div>
                </section>
            </section>
            -->
            <section>
		        <section data-background-image="images/robotics-richGeomStruct01.jpg" data-transition="convex">
		        </section>
		        
		        <section data-transition="convex">
		            <h2>Orientation error as a geodesic distance</h2>
		            <img src="images/ExpLog01.jpg" class="r-stretch">
		        </section>
		    </section>
            
            <section>
                <section data-load="ik2d.html" data-code="ik2d"></section>
                <section data-load="ik2d_damped.html" data-code="ik2d_damped"></section>
                <section data-load="ik2d_weighted.html" data-code="ik2d_weighted"></section>
                <section data-load="ik2d_prioritized.html" data-code="ik2d_prioritized"></section>
            </section>
            
            <section data-load="ik3d.html" data-code="ik3d"></section>
            <section data-load="bimanual2d.html" data-code="bimanual2d"></section>

			<section data-load="bimanual3d_ik.html" data-code="bimanual3d_ik"></section>
			<!--
            <section>
                <section data-load="bimanual3d_ik.html" data-code="bimanual3d_ik"></section>
                <section data-load="bimanual3d_prioritized.html" data-code="bimanual3d_prioritized"></section>
            </section>
            -->

            <!--<section data-load="humanoid2d_ik.html" data-code="humanoid2d_ik"></section>-->
            <section data-load="humanoid2d_com.html" data-code="humanoid2d_com"></section>
            <section>
                <section data-load="impedance2d_joint.html" data-code="impedance2d_joint"></section>
                <section data-load="impedance2d_task.html" data-code="impedance2d_task"></section>
                <section data-load="impedance2d_sdf.html" data-code="impedance2d_sdf"></section>
            </section>
            <section>
                <section data-load="impedance3d_joint.html" data-code="impedance3d_joint"></section>
                <section data-load="impedance3d_task.html" data-code="impedance3d_task"></section>
                <section data-load="impedance3d_sdf.html" data-code="impedance3d_sdf"></section>
            </section>
            <!--<section data-load="iLQR.html" data-code="ilqr"></section>-->
            <section data-load="humanoid3d_3.html" data-code="humanoid3d_3"></section>
        </div>
    </div>


    <script type="module">
        import Reveal from './reveal/reveal.esm.js';
        import { initViewer3D, initPyScript, downloadScene, downloadPandaRobot, downloadG1Robot } from '../viewer3d/viewer3d.js';
        import * as THREE from 'three';
        import * as math from 'mathjs';

        let currentPageParams = null;

        let mustStopLoop = false;
        let mustCallRun = false;
        let isLoopRunning = false;
        let loopStartTime = null;
        let loopPreviousTime = null;
        let aspectRatios = {};

        const tasks = [];
        let isExecutingTasks = false;


        Reveal.initialize({
            hash: true,
            plugins: [ RevealLoadContent ],
            width: 1600, 
            height: 900,
        });


        Reveal.on('ready', (event) => {
            convertMath();
        });


        function configure(params)
        {
            currentPageParams = params;

            document._setOutputTargets(
                currentPageParams.has('output') ? currentPageParams.get('output') : null,
                currentPageParams.has('errors') ? currentPageParams.get('errors') : null,
            );

            if (currentPageParams.has('setup'))
            {
                if (!Array.isArray(currentPageParams.get('setup')))
                    currentPageParams.set('setup', new Array(currentPageParams.get('setup')));
            }

            tasks.push(async () => {
                let runFunction = null;

                if (currentPageParams.has('loop'))
                {
                    runFunction = () => {
                        mustCallRun = true;
                    };
                }
                else if (currentPageParams.has('run'))
                {
                    runFunction = async () => {
                        await currentPageParams.get('run')();
                    };
                }
            });

            if (currentPageParams.has('setup'))
            {
                currentPageParams.get('setup').forEach((item, index) => {
                    tasks.push(item);
                });
            }

            if (currentPageParams.has('loop'))
            {
                tasks.push(async () => {
                    mustStopLoop = false;
                    isLoopRunning = true;
                    window.requestAnimationFrame(executeContentLoop);
                });
            }

            if (!isExecutingTasks)
                executeNextTask();

            // hideSplashScreen();
        }


        async function executeContentLoop(time)
        {
            if (loopStartTime === null)
            {
                loopStartTime = time;
                loopPreviousTime = time;
            }

            if (mustCallRun)
            {
                mustCallRun = false;
                loopStartTime = null;

                if (currentPageParams.has('run'))
                {
                    window.requestAnimationFrame(async () => {
                        await currentPageParams.get('run')();
                        window.requestAnimationFrame(executeContentLoop);
                    });
                }
                else
                {
                    window.requestAnimationFrame(executeContentLoop);
                }

                return;
            }

            await currentPageParams.get('loop')(time - loopPreviousTime, time - loopStartTime);

            loopPreviousTime = time;

            if (!mustStopLoop)
                window.requestAnimationFrame(executeContentLoop);
            else
                isLoopRunning = false;
        }


        async function stopContentLoop()
        {
            if (currentPageParams == null)
                return;

            if (isLoopRunning)
            {
                mustStopLoop = true;

                while (isLoopRunning)
                    await new Promise(r => setTimeout(r, 1));
            }

            if (currentPageParams.has('cleanup'))
                await currentPageParams.get('cleanup')();
        }


        function executeNextTask()
        {
            if (tasks.length > 0)
            {
                window.requestAnimationFrame(async (time) => {
                    const task = tasks.splice(0, 1)[0];
                    await task();
                    executeNextTask();
                });

                isExecutingTasks = true;
            }
            else
            {
                isExecutingTasks = false;
            }
        }


        function createEditors(parent)
        {
            const editors = parent.getElementsByTagName('editor');

            for (let i = 0; i < editors.length; ++i)
            {
                const element = editors[i];
                element.className = 'python-editor';

                let userCode = '';

                if (element.hasAttribute('src'))
                    userCode = document._getPythonScript(element.getAttribute('src'));
                else {
                    userCode = element.textContent;
                    element.textContent = '';
                }

                element.editor = CodeEditor.create(
                    element.id,
                    userCode,
                    (code) => {
                        document._pushOutputTargets(
                            element.hasAttribute('output') ? element.getAttribute('output') : null,
                            element.hasAttribute('errors') ? element.getAttribute('errors') : null,
                        );

                        document._clearOutputTargets();
                        document._executePythonCode(code);

                        mustCallRun = true;

                        document._popOutputTargets();
                    }
                )

                element.editor.defaultCode = userCode;
            }
        }


        function disposeEditors(parent)
        {
            const editors = parent.getElementsByTagName('editor');

            for (let i = 0; i < editors.length; ++i)
            {
                const element = editors[i];

                if (element.editor != null) {
                    const code = element.editor.getContent();
                    element.editor.destroy();
                    element.editor = null;
                    element.removeAttribute('src');
                    element.textContent = code;
                }
            }
        }


        // Convert the LaTeX formulas into HTML
        function convertMath()
        {
            const elements = document.getElementsByClassName("ltx_Math");
            const macros = {
                '\\tp': '\\text{\\tiny{#1}}',
                '\\trsp' : '\\top',
                '\\psin' : '\\dagger',
                '\\eqref': '\\href{###1}{(\\text{#1})}',
                '\\ref': '\\href{###1}{\\text{#1}}',
                '\\label': '\\htmlId{#1}{}'
            };

            for (let element of elements) {
                katex.render(element.textContent, element, {
                    throwOnError: false,
                    macros
                });
            }

            renderMathInElement(document.body, {
                trust: (context) => ['\\htmlId', '\\href'].includes(context.command),
                macros: macros,
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\begin{equation}', right: '\\end{equation}', display: true},
                    {left: '\\begin{equation*}', right: '\\end{equation*}', display: true},
                    {left: '\\begin{align}', right: '\\end{align}', display: true},
                    {left: '\\begin{align*}', right: '\\end{align*}', display: true},
                    {left: '\\begin{alignat}', right: '\\end{alignat}', display: true},
                    {left: '\\begin{gather}', right: '\\end{gather}', display: true},
                    {left: '\\begin{CD}', right: '\\end{CD}', display: true},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option', 'py-repl'],
            });
        }


        function setAspectRatio(id, ratio)
        {
            aspectRatios[id] = ratio;

            const element = document.getElementById(id);
            element.style.height = '' + (element.clientWidth * ratio) + 'px';

            window.dispatchEvent(new Event('resize'));
        }


        window.onresize = (evt) => {
            for (const [key, value] of Object.entries(aspectRatios)) {
                const element = document.getElementById(key);
                element.style.height = '' + (element.clientWidth * value) + 'px';
            }
        };


        window.onkeydown = (evt) => {
            function _getStyle() {
                const slide = Reveal.getCurrentSlide();
                const editors = slide.getElementsByTagName('editor');
                if (editors.length == 0)
                    return [null, null, null];

                const style = editors[0].style;

                return [slide, editors[0].editor, style];
            }

            function _updateFontSize(increment) {
                const [slide, editor, style] = _getStyle();
                if (slide == null)
                    return;

                let size = (style.fontSize != '' ? parseInt(style.fontSize) : 12) + increment;

                if (size >= 12) {
                    disposeEditors(slide);
                    style.fontSize = '' + size + 'px';
                    createEditors(slide);
                }
            }

            function _resetFontSize() {
                const [slide, editor, style] = _getStyle();
                if (slide == null)
                    return;

                disposeEditors(slide);
                style.fontSize = '';
                createEditors(slide);
            }

            if ((evt.key == 'ArrowUp') && (evt.ctrlKey || evt.metaKey)) {
                _updateFontSize(2);
                evt.preventDefault();
                evt.stopPropagation();
            }
            else if ((evt.key == 'ArrowDown') && (evt.ctrlKey || evt.metaKey)) {
                _updateFontSize(-2);
                evt.preventDefault();
                evt.stopPropagation();
            }

            else if ((evt.key == 'ArrowRight') && (evt.ctrlKey || evt.metaKey)) {
                _resetFontSize();
                evt.preventDefault();
                evt.stopPropagation();
            }
        };


        class ImpedancePlanarIKControls {

            constructor() {
                this.robot = null;
                this.offset = null;
                this.kinematicChain = null;

                this.plane = new three.Mesh(
                    new three.PlaneGeometry(100000, 100000, 2, 2),
                    new three.MeshBasicMaterial({ visible: false, side: three.DoubleSide})
                );

                this.u = null;
            }


            setup(robot, offset, kinematicChain, startPosition, planeDirection) {
                this.robot = robot;
                this.offset = offset;
                this.kinematicChain = kinematicChain;

                this.plane.position.copy(startPosition);

                this.plane.quaternion.setFromUnitVectors(new three.Vector3(0, 0, 1), planeDirection);
                this.plane.updateMatrixWorld(true);
            }


            process(raycaster) {
                let intersects = raycaster.intersectObject(this.plane, false);

                if (intersects.length > 0) {
                    let mu = intersects[0].point;
                    mu = math.matrix([mu.x, mu.y, mu.z]);

                    const x = Array.from(this.kinematicChain.getJointPositions());
                    const f = math.matrix(this.kinematicChain.fkin(x, this.offset));
                    const J = this.kinematicChain.Jkin(x, this.offset).subset(math.index(math.range(0, 3), math.range(0, this.kinematicChain.joints.length)));

                    let diff = math.subtract(mu, f.subset(math.index(math.range(0, 3))));
                    diff = math.multiply(diff, 20000.0);

                    let pinvJ;

                    try {
                        pinvJ = math.pinv(J);
                    }
                    catch(err) {
                        const JT = math.transpose(J);

                        pinvJ = math.multiply(
                            math.inv(
                                math.add(
                                    math.multiply(JT, J),
                                    math.multiply(math.identity(this.kinematicChain.joints.length), 1e-2)
                                )
                            ),
                            JT
                        );
                    }

                    this.u = math.multiply(pinvJ, diff)._data;
                }
            }
        }



        globalThis._createEditors = createEditors;
        globalThis._configure = configure;
        globalThis._stopContentLoop = stopContentLoop;
        globalThis._setAspectRatio = setAspectRatio;
        globalThis.Reveal = Reveal;
        globalThis.ImpedancePlanarIKControls = ImpedancePlanarIKControls;

        initViewer3D();

        await downloadScene('../3d_sandboxes/scenes/panda.xml');
        await downloadScene('../3d_sandboxes/scenes/panda_ghost.xml');
        await downloadScene('../3d_sandboxes/scenes/g1_upperbody.xml');
        await downloadScene('../3d_sandboxes/scenes/g1.xml');
        await downloadScene('./scenes/humanoid3d_3.xml');
        await downloadPandaRobot();
        await downloadG1Robot();

        initPyScript();
    </script>


    <script type="py">
        # This script defines the API usable from Python scripts in individual pages,
        # accessible by doing "from rcfs import ..."
        from pyscript import display
        from pyodide.ffi import to_js, create_proxy
        from js import document, console
        from js import _configure as _jsConfigure
        from js import _stopContentLoop as _jsStopContentLoop
        from js import _createEditors as _jsCreateEditors
        from js import _setAspectRatio as _jsSetAspectRatio
        from js import Reveal
        from js import ImpedancePlanarIKControls
        import types
        import sys
        import traceback


        _output = None
        _errors = None
        _savedOutput = None
        _savedErrors = None
        _errorMessageDisplayed = False

        _display = display

        def display(*kargs, **kwargs):
            if ('target' not in kwargs) and (_output is not None):
                kwargs['target'] = _output

            if len(kargs) == 0:
                kargs = ['\n']

            _display(*kargs, **kwargs)
            console.log(*[ repr(x) for x in kargs ])

        print = display


        def _displayError(exception):
            global _errorMessageDisplayed

            if _errorMessageDisplayed:
                return

            text = traceback.format_exception(exception)
            text = ''.join(text)
            console.log(text)

            if _errors:
                el = document.getElementById(_errors)
                if el:
                    el.textContent= text

            _errorMessageDisplayed = True


        def _clearOutputTargets():
            global _errorMessageDisplayed

            if _output:
                el = document.getElementById(_output)
                if el:
                    el.innerText = ''

            if _errors:
                el = document.getElementById(_errors)
                if el:
                    el.innerText = ''

            _errorMessageDisplayed = False


        def _setOutputTargets(output, errors):
            global _output, _errors

            _output = output
            _errors = errors


        def _pushOutputTargets(output, errors):
            global _output, _errors, _savedOutput, _savedErrors

            if output is not None:
                _savedOutput = _output
                _output = output

            if errors is not None:
                _savedErrors = _errors
                _errors = errors


        def _popOutputTargets():
            global _output, _errors, _savedOutput, _savedErrors

            if _savedOutput is not None:
                _output = _savedOutput
                _savedOutput = None

            if _savedErrors is not None:
                _errors = _savedErrors
                _savedErrors = None


        def _configure(config):
            _jsConfigure(to_js(config))


        def _getPythonScript(id):
            script = document.getElementById(id)
            if (script is None) or (script.tagName != 'SCRIPT'):
                return None

            code = script.textContent

            if code[0] == '\n':
                code = code[1:]

            if code[0] == ' ':
                indent = 1
                while code[indent] == ' ':
                    indent += 1

                lines = code.split('\n')
                lines = [ l[indent:] if len(l) >= indent else l for l in lines ]
                code = '\n'.join(lines)

            if code[-1] == '\n':
                code = code[:-1]

            return code


        def _executePythonCode(code):
            if code is None:
                return

            try:
                exec(code, globals())
            except Exception as e:
                _displayError(e)


        def _executePythonScript(id):
            _executePythonCode(_getPythonScript(id))


        def _executePythonCodeAsModule(code, moduleName):
            if code is None:
                return

            try:
                _globals = {}
                exec(code, _globals)
                _module = types.ModuleType(moduleName)
                for k in _globals.keys():
                    setattr(_module, k, _globals[k])
                sys.modules[moduleName] = _module
            except Exception as e:
                _displayError(e)


        # Functions that must be accessible from JS
        document._displayError = _displayError
        document._clearOutputTargets = _clearOutputTargets
        document._setOutputTargets = _setOutputTargets
        document._pushOutputTargets = _pushOutputTargets
        document._popOutputTargets = _popOutputTargets
        document._executePythonScript = _executePythonScript
        document._executePythonCode = _executePythonCode
        document._getPythonScript = _getPythonScript


        # Functions that must be accessible from Python, collected into the 'rcfs' module
        _rcfs = types.ModuleType('rcfs')
        _rcfs.displayError = _displayError
        _rcfs.configure = _configure
        _rcfs.executePythonScript = _executePythonScript
        _rcfs.executePythonCode = _executePythonCode
        _rcfs.executePythonCodeAsModule = _executePythonCodeAsModule
        _rcfs.setAspectRatio = _jsSetAspectRatio
        _rcfs.ImpedancePlanarIKControls = ImpedancePlanarIKControls;

        sys.modules['rcfs'] = _rcfs


        def onReady(event):
            _jsCreateEditors(document)

            currentSlide = Reveal.getCurrentSlide()
            if currentSlide.hasAttribute('data-code'):
                prefix = currentSlide.getAttribute('data-code')
                _executePythonScript(prefix + '_page_code')

            document.getElementById('loader-container').style.display = 'none'


        async def onSlideChanged(event):
            if event.previousSlide.hasAttribute('data-code'):
                await _jsStopContentLoop()

            if event.currentSlide.hasAttribute('data-code'):
                prefix = event.currentSlide.getAttribute('data-code')
                _executePythonScript(prefix + '_page_code')


        Reveal.on('slidechanged', create_proxy(onSlideChanged))

        if Reveal.isReady():
            onReady(None)
        else:
            Reveal.on('ready', create_proxy(onReady))
    </script>

</body>
</html>
