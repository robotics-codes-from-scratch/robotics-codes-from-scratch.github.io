
<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="My awesome project" name="description"/>
  <meta content="awesome" name="keywords"/>
  <meta content="John Doe" name="author"/>
  <title>
   My awesome project
  </title>
  <link href="static_images/favicon.ico" rel="icon" sizes="any"/>
  <link href="static_images/favicon.svg" rel="icon" type="image/svg+xml"/>
  <link href="css/bootstrap.min.css" rel="stylesheet"/>
  <link href="css/bootstrap-icons-1.10.4/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="css/permanent_marker.css" rel="stylesheet"/>
  <link href="css/main-template.css" rel="stylesheet"/>
  <link href="css/sidebars.css" rel="stylesheet"/>
  <script src="js/jquery-3.6.4.min.js">
  </script>
  <script src="js/bootstrap.bundle.min.js">
  </script>
 </head>
 <body>
  <nav aria-label="Light offcanvas navbar" class="navbar fixed-top" style="width: 50px;">
   <div class="container-fluid">
    <button aria-controls="offcanvasNavbarLight" class="navbar-toggler" data-bs-target="#offcanvasNavbarLight" data-bs-toggle="offcanvas" type="button">
     <span class="navbar-toggler-icon" style="cursor: pointer;">
     </span>
    </button>
    <div aria-labelledby="offcanvasNavbarLightLabel" class="offcanvas offcanvas-start" id="offcanvasNavbarLight" style="width: 500px;" tabindex="-1">
     <div class="offcanvas-header">
      <!--style='height: 50px;'-->
      <a class="navbar-brand" href="index.html">
       <h4 class="offcanvas-title" id="offcanvasNavbarLightLabel">
        <i class="bi bi-robot">
        </i>
        <i class="bi bi-code-slash">
        </i>
        RCFS
       </h4>
      </a>
      <button aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button">
      </button>
     </div>
     <div class="offcanvas-body">
      <!--Menu goes here-->
      <ul class="list-unstyled ps-0" id="menu_container">
       <li class="border-top my-1">
       </li>
       <li class="mb-1">
        <button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#general-collapse" data-bs-toggle="collapse">
         General information
        </button>
        <div class="collapse show" id="general-collapse">
         <!--<li><a href='index.html' class='link-dark d-inline-flex text-decoration-none rounded'>Home</a></li>-->
         <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="about.html">
            <div class="p-1 mb-0">
             About
            </div>
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="border-top my-1">
       </li>
       <li class="mb-1">
        <button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#sandboxes2d-collapse" data-bs-toggle="collapse">
         2D sandboxes
        </button>
        <div class="collapse show" id="sandboxes2d-collapse">
         <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_FK.html">
            <div class="p-1 mb-0">
             Forward kinematics (FK)
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_IK.html">
            <div class="p-1 mb-0">
             Inverse kinematics (IK)
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_bimanual.html">
            <div class="p-1 mb-0">
             Bimanual robot
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_humanoid.html">
            <div class="p-1 mb-0">
             Humanoid robot (CoM and coordination matrix)
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR.html">
            <div class="p-1 mb-0">
             Iterative linear quadratic regulator (iLQR)
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR_car.html">
            <div class="p-1 mb-0">
             iLQR for car
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR_bicopter.html">
            <div class="p-1 mb-0">
             iLQR for bicopter
            </div>
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="border-top my-1">
       </li>
       <li class="mb-1">
        <button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#sandboxes3d-collapse" data-bs-toggle="collapse">
         3D sandboxes
        </button>
        <div class="collapse show" id="sandboxes3d-collapse">
         <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox3d_IK.html">
            <div class="p-1 mb-0">
             Inverse kinematics (IK)
            </div>
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="border-top my-1">
       </li>
       <li class="mb-1">
        <button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#exercises-collapse" data-bs-toggle="collapse">
         Exercises
        </button>
        <div class="collapse show" id="exercises-collapse">
         <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise01.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             01
            </div>
            <div class="p-1 mb-0">
             Linear algebra in Python
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise02.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             02
            </div>
            <div class="p-1 mb-0">
             Movement primitives and Newton's method
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise03.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             03
            </div>
            <div class="p-1 mb-0">
             Gaussian Distributions
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise04a.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             4a
            </div>
            <div class="p-1 mb-0">
             Forward kinematics
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise04b.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             4b
            </div>
            <div class="p-1 mb-0">
             Inverse kinematics and nullspace control
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise05a.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             5a
            </div>
            <div class="p-1 mb-0">
             Forward dynamics
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise05b.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             5b
            </div>
            <div class="p-1 mb-0">
             Inverse dynamics and impedance control
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise06a.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             6a
            </div>
            <div class="p-1 mb-0">
             Planning with linear quadratic regulator
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise06b.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             6b
            </div>
            <div class="p-1 mb-0">
             Planning in joint space with LQR
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise07.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             07
            </div>
            <div class="p-1 mb-0">
             Iterative linear quadratic regulator (iLQR)
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise08.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             08
            </div>
            <div class="p-1 mb-0">
             Exploration with ergodic control
            </div>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise09.html">
            <div class="p-1 mb-0 bg-dark text-white font-monospace">
             09
            </div>
            <div class="p-1 mb-0">
             Orientation with Riemannian manifold
            </div>
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="border-top my-1">
       </li>
       <li class="mb-1">
        <a class="link-dark d-inline-flex text-decoration-none rounded" href="S1.html">
         <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0" data-bs-toggle="collapse" style="text-align:left;">
          1 Introduction
         </button>
        </a>
       </li>
       <li class="mb-1">
        <button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#Newtonsmethodforminimization-collapse" data-bs-toggle="collapse" style="text-align:left;">
         2 Newton’s method for minimization
        </button>
        <div class="collapse show" id="Newtonsmethodforminimization-collapse">
         <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html">
            <span class="p-1 mb-0">
             2 Newton’s method for minimization
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:GaussNewton">
            <span class="p-1 mb-0">
             2.1 Gauss–Newton algorithm
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:LS">
            <span class="p-1 mb-0">
             2.2 Least squares
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:LSconstraints">
            <span class="p-1 mb-0">
             2.3 Least squares with constraints
            </span>
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="mb-1">
        <a class="link-dark d-inline-flex text-decoration-none rounded" href="S3.html">
         <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0" data-bs-toggle="collapse" style="text-align:left;">
          3 Forward kinematics (FK) for a planar robot manipulator
         </button>
        </a>
       </li>
       <li class="mb-1">
        <button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#InversekinematicsIKforaplanarrobotmanipulator-collapse" data-bs-toggle="collapse" style="text-align:left;">
         4 Inverse kinematics (IK) for a planar robot manipulator
        </button>
        <div class="collapse show" id="InversekinematicsIKforaplanarrobotmanipulator-collapse">
         <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html">
            <span class="p-1 mb-0">
             4 Inverse kinematics (IK) for a planar robot manipulator
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html#sec:IKnum">
            <span class="p-1 mb-0">
             4.1 Numerical estimation of the Jacobian
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html#sec:IK_nullspace">
            <span class="p-1 mb-0">
             4.2 Inverse kinematics (IK) with task prioritization
            </span>
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="mb-1">
        <button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#Encodingwithbasisfunctions-collapse" data-bs-toggle="collapse" style="text-align:left;">
         5 Encoding with basis functions
        </button>
        <div class="collapse show" id="Encodingwithbasisfunctions-collapse">
         <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html">
            <span class="p-1 mb-0">
             5 Encoding with basis functions
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS1">
            <span class="p-1 mb-0">
             5.1 Univariate trajectories
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS2">
            <span class="p-1 mb-0">
             5.2 Multivariate trajectories
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS3">
            <span class="p-1 mb-0">
             5.3 Multidimensional inputs
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS4">
            <span class="p-1 mb-0">
             5.4 Concatenated basis functions
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS5">
            <span class="p-1 mb-0">
             5.5 Batch computation of basis functions coefficients
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS6">
            <span class="p-1 mb-0">
             5.6 Recursive computation of basis functions coefficients
            </span>
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="mb-1">
        <button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#LinearquadratictrackingLQT-collapse" data-bs-toggle="collapse" style="text-align:left;">
         6 Linear quadratic tracking (LQT)
        </button>
        <div class="collapse show" id="LinearquadratictrackingLQT-collapse">
         <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html">
            <span class="p-1 mb-0">
             6 Linear quadratic tracking (LQT)
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#SS1">
            <span class="p-1 mb-0">
             6.1 LQT with smoothness cost
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#SS2">
            <span class="p-1 mb-0">
             6.2 LQT with control primitives
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:LQRrecursive">
            <span class="p-1 mb-0">
             6.3 LQR with a recursive formulation
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:augmState">
            <span class="p-1 mb-0">
             6.4 LQT with a recursive formulation and an augmented state space
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:LQRLS">
            <span class="p-1 mb-0">
             6.5 Least squares formulation of recursive LQR
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:DMPLQT">
            <span class="p-1 mb-0">
             6.6 Dynamical movement primitives (DMP) reformulated as LQT with control primitives
            </span>
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="mb-1">
        <button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#iLQRoptimization-collapse" data-bs-toggle="collapse" style="text-align:left;">
         7 iLQR optimization
        </button>
        <div class="collapse show" id="iLQRoptimization-collapse">
         <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html">
            <span class="p-1 mb-0">
             7 iLQR optimization
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRbatch">
            <span class="p-1 mb-0">
             7.1 Batch formulation of iLQR
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRrecursive">
            <span class="p-1 mb-0">
             7.2 Recursive formulation of iLQR
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRLS">
            <span class="p-1 mb-0">
             7.3 Least squares formulation of recursive iLQR
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS4">
            <span class="p-1 mb-0">
             7.4 Updates by considering step sizes
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS5">
            <span class="p-1 mb-0">
             7.5 iLQR with quadratic cost on f(x_{t})
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS6">
            <span class="p-1 mb-0">
             7.6 iLQR with control primitives
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS7">
            <span class="p-1 mb-0">
             7.7 iLQR for spacetime optimization
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS8">
            <span class="p-1 mb-0">
             7.8 iLQR with offdiagonal elements in the precision matrix
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS9">
            <span class="p-1 mb-0">
             7.9 Car steering
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS10">
            <span class="p-1 mb-0">
             7.10 Bicopter
            </span>
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="mb-1">
        <button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#ForwarddynamicsFDforaplanarrobotmanipulator-collapse" data-bs-toggle="collapse" style="text-align:left;">
         8 Forward dynamics (FD) for a planar robot manipulator
        </button>
        <div class="collapse show" id="ForwarddynamicsFDforaplanarrobotmanipulator-collapse">
         <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S8.html">
            <span class="p-1 mb-0">
             8 Forward dynamics (FD) for a planar robot manipulator
            </span>
           </a>
          </li>
          <li>
           <a class="link-dark d-inline-flex text-decoration-none rounded" href="S8.html#SS1">
            <span class="p-1 mb-0">
             8.1 Robot manipulator with dynamics equation
            </span>
           </a>
          </li>
         </ul>
        </div>
       </li>
       <li class="mb-1">
        <a class="link-dark d-inline-flex text-decoration-none rounded" href="bib.html">
         <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0" data-bs-toggle="collapse" style="text-align:left;">
          References
         </button>
        </a>
       </li>
       <li class="mb-1">
        <a class="link-dark d-inline-flex text-decoration-none rounded" href="A1.html">
         <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0" data-bs-toggle="collapse" style="text-align:left;">
          A System dynamics at trajectory level
         </button>
        </a>
       </li>
       <li class="mb-1">
        <a class="link-dark d-inline-flex text-decoration-none rounded" href="A2.html">
         <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0" data-bs-toggle="collapse" style="text-align:left;">
          B Derivation of motion equation for a planar robot
         </button>
        </a>
       </li>
       <li class="mb-1">
        <a class="link-dark d-inline-flex text-decoration-none rounded" href="A3.html">
         <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0" data-bs-toggle="collapse" style="text-align:left;">
          C Linear systems used in the bimanual tennis serve example
         </button>
        </a>
       </li>
       <li class="mb-1">
        <a class="link-dark d-inline-flex text-decoration-none rounded" href="A4.html">
         <button class="btn btn-toggle d-inline-flex align-items-center rounded border-0" data-bs-toggle="collapse" style="text-align:left;">
          D Equivalence between LQT and LQR with augmented state space
         </button>
        </a>
       </li>
      </ul>
     </div>
    </div>
   </div>
  </nav>
  <script defer="" src="https://pyscript.net/latest/pyscript.min.js">
  </script>
  <py-config type="toml">
   packages = ['numpy']
  </py-config>
  <link href="https://pyscript.net/latest/pyscript.css" rel="stylesheet"/>
  <!-- pyscript.css is incompatible with hypothes.is/embed.js-->
  <div class="container-fluid">
   <div class="row">
    <div class="col-sm-1">
    </div>
    <div class="col-sm-7">
     <br/>
     <br/>
     <script>
      function clearMsgs() {
  const el = document.getElementById('repl-err');
  el.innerText = '';
  //console.log('event!');
}
     </script>
     <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
       <button aria-controls="IK-tab-pane" aria-selected="true" class="nav-link active" data-bs-target="#IK-tab-pane" data-bs-toggle="tab" id="IK-tab" role="tab" type="button">
        IK
       </button>
      </li>
      <li class="nav-item" role="presentation">
       <button aria-controls="pIK-tab-pane" aria-selected="false" class="nav-link" data-bs-target="#pIK-tab-pane" data-bs-toggle="tab" id="pIK-tab" role="tab" type="button">
        Prioritized IK
       </button>
      </li>
     </ul>
     <div class="tab-content" id="myTabContent">
      <div aria-labelledby="IK-tab" class="tab-pane fade show active" id="IK-tab-pane" role="tabpanel" tabindex="0">
       <div onclick="clearMsgs()" onkeydown="clearMsgs()">
        <py-repl std-err="repl-err" std-out="repl-out">
         def controlCommand(x, param):
  f = fkin(x, param)
  J = Jkin(x, param)
  #u = np.linalg.pinv(J) @ (param.Mu - f[:,0]) * 10 # Control commands
  #u = np.zeros(param.nbVarX) # Control commands
  pinvJ = np.linalg.inv(J.T @ J + np.eye(param.nbVarX) * 1E4) @ J.T # Damped pseudoinverse
  u = pinvJ @ (param.Mu - f[:,0]) * 10 # Control commands
  return u
        </py-repl>
        <!--output='repl-out' std-out='repl-out'-->
       </div>
      </div>
      <div aria-labelledby="pIK-tab" class="tab-pane fade" id="pIK-tab-pane" role="tabpanel" tabindex="0">
       <div onclick="clearMsgs()" onkeydown="clearMsgs()">
        <py-repl std-err="repl-err" std-out="repl-out">
         def controlCommand(x, param):
  f = fkin(x, param)
  J = Jkin(x, param)
  # Prioritized control (left tracking as main objective)
  dfl = (param.Mu[:2] - f[:2,0]) * 10 # Left hand correction
  dfr = (param.Mu[2:] - f[2:,0]) * 10 # Right hand correction
  Jl = J[:2,:] # Jacobian for left hand
  Jr = J[2:,:] # Jacobian for right hand
  pinvJl = np.linalg.inv(Jl.T @ Jl + np.eye(param.nbVarX) * 1e1) @ Jl.T # Damped pseudoinverse
  Nl = np.eye(param.nbVarX) - pinvJl @ Jl # Nullspace projection operator
  ul = pinvJl @ dfl # Command for position tracking
  JrNl = Jr @ Nl
  pinvJrNl = JrNl.T @ np.linalg.inv(JrNl @ JrNl.T + np.eye(2) * 1e4) # Damped pseudoinverse
  ur = pinvJrNl @ (dfr - Jr @ ul) # Command for right hand tracking (with left hand tracking prioritized)
  u = ul + Nl @ ur # Control commands
  return u
        </py-repl>
        <!--output='repl-out' std-out='repl-out'-->
       </div>
      </div>
     </div>
     <!--tab-content-->
     <p id="repl-out" style="font-size: 70%; color: #777777;">
      (click on the green run button to run the code; objects and joints can be moved with the mouse)
     </p>
     <p id="repl-err" style="font-size: 70%; color: #880000;">
     </p>
    </div>
    <!--sm-7-->
    <div class="col-sm-4">
     <div class="sticky-sm-top">
      <canvas height="700px" id="canvas" style="width:100%;" width="900px">
      </canvas>
     </div>
    </div>
    <!--sm-4-->
   </div>
   <!--row-->
   <py-script>
    from pyodide.ffi import create_proxy
from js import Path2D, document, console
import numpy as np
import asyncio

# Forward kinematics for end-effector (in robot coordinate system)
def fkin(x, param):
    L = np.tril(np.ones(3))
    f = np.vstack([
        param.l[0:3].T @ np.cos(L @ x[0:3]),
        param.l[0:3].T @ np.sin(L @ x[0:3]),
        param.l[[0,3,4]].T @ np.cos(L @ x[[0,3,4]]),
        param.l[[0,3,4]].T @ np.sin(L @ x[[0,3,4]])
    ])  # f1,f2,f3,f4
    return f

# Forward kinematics for end-effector (in robot coordinate system)
def fkin0(x, param):
    L = np.tril(np.ones(3))
    fl = np.vstack([
        L @ np.diag(param.l[0:3]) @ np.cos(L @ x[0:3]),
        L @ np.diag(param.l[0:3]) @ np.sin(L @ x[0:3])
    ])
    fr = np.vstack([
        L @ np.diag(param.l[[0,3,4]]) @ np.cos(L @ x[[0,3,4]]),
        L @ np.diag(param.l[[0,3,4]]) @ np.sin(L @ x[[0,3,4]])
    ])
    f = np.hstack([fl[:,::-1], np.zeros([2,1]), fr])
    return f

# Jacobian of the end-effector with analytical computation (for single time step)
def Jkin(x, param):
    L = np.tril(np.ones(3))
    J = np.zeros((param.nbVarF, param.nbVarX))
    Jl = np.vstack([-np.sin(L @ x[:3]).T @ np.diag(param.l[:3]) @ L,
                    np.cos(L @ x[:3]).T @ np.diag(param.l[:3]) @ L
                    ])
    Jr = np.vstack([-np.sin(L @ x[[0,3,4]]).T @ np.diag(np.array(param.l)[[0,3,4]]) @ L,
                    np.cos(L @ x[[0,3,4]]).T @ np.diag(np.array(param.l)[[0,3,4]]) @ L
                    ])
    J[:Jl.shape[0], :Jl.shape[1]] = Jl
    J[2:, [0,3,4]] = Jr
    return J


## Parameters
# ===============================

param = lambda: None # Lazy way to define an empty class in python
param.dt = 1e-1 # Time step length
param.nbVarX = 5 # State space dimension
param.nbVarF = 4 # Task space dimension ([x1,x2] for left end-effector, [x3,x4] for right end-effector)
param.l = np.array([200, 200, 150, 200, 150]) # Robot links lengths
param.Mu = np.array([-200, 100, 200, 100]) # Objects position

#########################################################################################

# Mouse events
mouse0 = np.zeros(2)
mouse = np.zeros(2)
mousedown = 0
hover_joint = -1
selected_obj = -1
move_joint= -1
hover0 = np.zeros(2)

def onMouseMove(event):
	global mouse, mouse0, hover0, x
	offset = canvas.getBoundingClientRect()
	mouse0[0] = (event.clientX - offset.x) * canvas.width / canvas.clientWidth
	mouse0[1] = (event.clientY - offset.y) * canvas.height / canvas.clientHeight
	mouse[0] = (mouse0[0] - canvas.width * 0.5)
	mouse[1] = -(mouse0[1] - canvas.height * 0.9)
	if move_joint &gt;= 0:
		x[move_joint] -= 1E-2 * np.sum(hover0 - mouse0)
		hover0 = np.copy(mouse0)

def onTouchMove(event):
	global mouse, mouse0, hover0, x
	offset = event.target.getBoundingClientRect()
	mouse0[0] = (event.touches.item(0).clientX - offset.x) * canvas.width / canvas.clientWidth
	mouse0[1] = (event.touches.item(0).clientY - offset.y) * canvas.height / canvas.clientHeight
	mouse[0] = (mouse0[0] - canvas.width * 0.5)
	mouse[1] = -(mouse0[1] - canvas.height * 0.9)
	if move_joint &gt;= 0:
		x[move_joint] -= 1E-2 * np.sum(hover0 - mouse0)
		hover0 = np.copy(mouse0)

def onMouseDown(event):
	global mousedown, move_joint, hover0
	mousedown = 1
	if hover_joint &gt;= 0:
		move_joint = hover_joint
		hover0 = np.copy(mouse0)

def onMouseUp(event):
	global mousedown, selected_obj, move_joint
	mousedown = 0
	selected_obj = -1
	move_joint = -1

def onWheel(event):
	global hover_joint, x
	if hover_joint &gt;= 0:
		x[hover_joint] -= 0.2 * (event.deltaY/106)

document.addEventListener('mousemove', create_proxy(onMouseMove)) #for standard mouse
document.addEventListener('touchmove', create_proxy(onTouchMove)) #for mobile interfaces

document.addEventListener('mousedown', create_proxy(onMouseDown)) #for standard mouse
#document.addEventListener('pointerdown', create_proxy(onMouseDown)) #for mobile interfaces
document.addEventListener('touchstart', create_proxy(onMouseDown)) #for mobile interfaces

document.addEventListener('mouseup', create_proxy(onMouseUp)) #for standard mouse
#document.addEventListener('pointerup', create_proxy(onMouseUp)) #for mobile interfaces
document.addEventListener('touchend', create_proxy(onMouseUp)) #for mobile interfaces

document.addEventListener('wheel', create_proxy(onWheel)) #for standard mouse


#########################################################################################

canvas = document.getElementById('canvas')
ctx = canvas.getContext('2d')

def clear_screen():
	ctx.setTransform(1, 0, 0, 1, 0, 0)
	ctx.fillStyle = 'white'
	ctx.fillRect(0, 0, canvas.width, canvas.height)


def draw_ground():
	ctx.setTransform(1, 0, 0, -1, canvas.width*0.5, canvas.height*0.9)
	ctx.lineCap = 'round'
	ctx.lineJoin = 'round'
	ctx.lineWidth = '5'
	ctx.strokeStyle = '#CCCCCC'
	ctx.beginPath()
	ctx.moveTo(-400, 0)
	ctx.lineTo(400, 0)
	ctx.stroke()


def draw_robot(x, color):
	global hover_joint
	ctx.setTransform(1, 0, 0, -1, canvas.width*0.5, canvas.height*0.9)

	f = fkin0(x, param)

	# Draw base
	ctx.translate(f[0,3], f[1,3])
	ctx.lineWidth = '4'
	ctx.strokeStyle = 'white'
	ctx.fillStyle = color
	ctx.beginPath()
	ctx.arc(0, 0, 40, 0, np.pi)
	ctx.rect(-40, 0, 80, -40)
	ctx.fill()
	ctx.strokeStyle = color
	for i in range(5):
		ctx.beginPath()
		ctx.moveTo(-30+i*15, -40)
		ctx.lineTo(-40+i*15, -60)
		ctx.stroke()

	# Draw links and articulations
	obj = Path2D.new()
	obj.arc(0, 0, 12, 0, 2*np.pi)
	ctx.lineCap = 'round'
	ctx.lineJoin = 'round'
	for i in range(param.nbVarX+2):
		if i &lt; param.nbVarX+1:
			# Draw links outlines
			ctx.lineWidth = '46'
			ctx.strokeStyle = 'white'
			ctx.beginPath()
			ctx.lineTo(f[0,i], f[1,i])
			ctx.lineTo(f[0,i+1], f[1,i+1])
			ctx.stroke()
			# Draw links
			ctx.lineWidth = '38'
			ctx.strokeStyle = color
			ctx.beginPath()
			ctx.lineTo(f[0,i], f[1,i])
			ctx.lineTo(f[0,i+1], f[1,i+1])
			ctx.stroke()
		# Draw articulations
		ctx.lineWidth = '4'
		ctx.strokeStyle = 'white'
		ctx.translate(f[0,i], f[1,i])
		ctx.stroke(obj)
		if ctx.isPointInPath(obj, mouse0[0], mouse0[1]) and i&gt;0:
			if i&lt;4:
				hover_joint = 3-i
			else:
				hover_joint = i-1
		ctx.translate(-f[0,i], -f[1,i])


def draw_object(xobj, id, color):
	global selected_obj
	ctx.setTransform(1, 0, 0, -1, canvas.width*0.5, canvas.height*0.9)
	# Draw object
	obj = Path2D.new()
	obj.arc(0, 0, 22, 0, 2*np.pi)
	ctx.translate(xobj[0], xobj[1])
	ctx.fillStyle = color
	ctx.fill(obj)
	if ctx.isPointInPath(obj, mouse0[0], mouse0[1]) and mousedown==1:
		selected_obj = id


def controlCommand(x, param):
	#f = fkin(x, param)
	#J = Jkin(x, param)
	#u = np.linalg.pinv(J) @ (param.Mu - f[:,0]) * 10
	u = np.zeros(param.nbVarX)
	return u

#########################################################################################

def errorHandler(e):
	msg = 'Error: ' + str(e)
	console.error(msg)
	el = document.getElementById('repl-err')
	el.innerText = msg
	#el.textContent = msg

#########################################################################################
x = np.array([np.pi/2, np.pi/2, np.pi/4, -np.pi/2, -np.pi/4]) # Initial robot state
#u = np.zeros(param.nbVarX)

async def main():
	global hover_joint, x

	while True:
		try:
			u = controlCommand(x, param)
		except Exception as e:
			errorHandler(e)
			u = np.zeros(param.nbVarX)

		x += u * param.dt

		# Reinit hovering variables
		hover_joint = -1

		# Rendering
		clear_screen()
		#draw_ground()
		draw_robot(x, '#AAAAAA')
		draw_object(param.Mu[:2], 0, '#FF3399')
		draw_object(param.Mu[2:], 1, '#FF9933')

		# Object selection
		if selected_obj==0:
			param.Mu[:2] = mouse[:2]
			param.Mu[0] = max(min(param.Mu[0],450), -450)
			param.Mu[1] = max(min(param.Mu[1],630), -70)
		if selected_obj==1:
			param.Mu[2:] = mouse[:2]
			param.Mu[2] = max(min(param.Mu[2],450), -450)
			param.Mu[3] = max(min(param.Mu[3],630), -70)
		await asyncio.sleep(0.0001)

pyscript.run_until_complete(main())
   </py-script>
  </div>
  <!--container-->
 </body>
</html>
