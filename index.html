<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="RCFS" name="description"/>
    <meta content="robotics codes, robotics tutorial, rcfs, robotics from scratch" name="keywords"/>
    <meta content="Sylvain Calinon" name="author"/>

    <title>RCFS</title>

    <link href="static_images/favicon.ico" rel="icon" sizes="any"/>
    <link href="static_images/favicon.svg" rel="icon" type="image/svg+xml"/>

    <link href="css/bootstrap.min.css" rel="stylesheet"/>
    <link href="css/bootstrap-icons-1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <link href="css/permanent_marker.css" rel="stylesheet"/>
    <link href="css/sidebars.css" rel="stylesheet"/>
    <link href="css/katex.min.css" rel="stylesheet"/>
    <link href="https://pyscript.net/latest/pyscript.css" rel="stylesheet"/>
    <link href="css/main-template.css" rel="stylesheet"/>

    <script src="js/jquery-3.6.4.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/katex.min.js"></script>
    <script src="js/katex-auto-render.js"></script>

    <py-config type="toml">
        packages = ['numpy', 'matplotlib']
        [[fetch]]
            from = 'viewer3d/'
            files = ['viewer3d.py']
    </py-config>

    <style>
        a {
            cursor: pointer;
        }
    </style>

    <!-- Import all the necessary JavaScript dependency modules -->
    <script src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.141.0/build/three.module.js",
                "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.141.0/examples/jsm/",
                "mujoco": "./viewer3d/jsm/mujoco_wasm.js",
                "katex": "https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.mjs",
                "mathjs": "https://cdn.jsdelivr.net/npm/mathjs@12.0.0/+esm"
            }
        }
    </script>
</head>

<body>
    <nav aria-label="Light offcanvas navbar" class="navbar fixed-top" style="width: 50px;">
        <div class="container-fluid">
            <button aria-controls="offcanvasNavbarLight" class="navbar-toggler" data-bs-target="#offcanvasNavbarLight" data-bs-toggle="offcanvas" type="button">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div aria-labelledby="offcanvasNavbarLightLabel" class="offcanvas offcanvas-start" id="offcanvasNavbarLight" style="width: 500px;" tabindex="-1">
                <div class="offcanvas-header">
                    <a class="navbar-brand" href="#">
                        <h4 class="offcanvas-title" id="offcanvasNavbarLightLabel"> <i class="bi bi-code-slash"></i> RCFS</h4>
                    </a>
                    <button id="close-button" aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button"></button>
                </div>
                <div class="offcanvas-body">
                    <!--Menu goes here-->
                    <ul id="menu" class="list-unstyled ps-0"></ul>
                </div>
            </div>
        </div>
    </nav>

    <!--Pages content goes here-->
    <div id="content" class="container-fluid"></div>

    <script type="module">
        import { initViewer3D, downloadScene, downloadPandaRobot } from './viewer3d/viewer3d.js';

        // Retrieve the base URL of the page
        const url = window.location;
        const baseUrl = url.origin + url.pathname.substring(0, url.pathname.lastIndexOf('/'));

        let currentPage = null;
        let btnSave = null;
        let btnOpen = null;
        let navlinks = null;

        const div = document.getElementById('content');
        const closeMenuButton = document.getElementById('close-button');
        const pages = new Map();

        const loadedRequirements = {
            viewer3d: false,
            pyscript: false,
        };

        const loadedRobots = [];
        const loadedScenes = [];
        const loadedScripts = {};

        const tasks = [];


        // Populate the menu content
        async function initMenu()
        {
            const response = await fetch(baseUrl + '/menu.json');
            const content = await response.json();

            const menu = document.getElementById('menu');

            let hash = url.hash.substr(1);
            if (hash == '')
                hash = 'home';

            content.forEach((category) => {
                const separator = document.createElement('li');
                separator.className = 'border-top my-1';
                menu.appendChild(separator);

                const categoryElement = document.createElement('li');
                categoryElement.className = 'mb-1';

                const button = document.createElement('button');
                button.className = 'btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed';
                button.setAttribute('aria-expanded', 'false');
                button.setAttribute('data-bs-target', '#' + category.id + '-collapse');
                button.setAttribute('data-bs-toggle', 'collapse');
                button.textContent = category.title;
                categoryElement.appendChild(button);

                const categoryContent = document.createElement('div');
                categoryContent.id = category.id + '-collapse';
                categoryContent.className = 'collapse';
                categoryElement.appendChild(categoryContent);

                const entriesElement = document.createElement('ul');
                entriesElement.className = 'btn-toggle-nav list-unstyled fw-normal pb-1 small';
                categoryContent.appendChild(entriesElement);

                category.entries.forEach((entry) => {
                    if (hash == entry.hash)
                    {
                        button.setAttribute('aria-expanded', 'true');
                        categoryContent.classList.add('show');
                    }

                    if (!entry.hidden)
                    {
                        const entryElement = document.createElement('li');

                        const link = document.createElement('a');
                        link.className = 'link-dark d-inline-flex text-decoration-none rounded';
                        link.style.cursor = 'pointer';
                        link.href = '#' + entry.hash;
                        entryElement.appendChild(link);

                        if (entry.number != undefined)
                        {
                            const numberDiv = document.createElement('div');
                            numberDiv.className = 'p-1 mb-0 bg-dark text-white font-monospace';
                            numberDiv.textContent = entry.number;
                            link.appendChild(numberDiv);
                        }

                        const entryDiv = document.createElement('div');
                        entryDiv.className = 'p-1 mb-0';
                        entryDiv.textContent = entry.title;
                        link.appendChild(entryDiv);

                        if (entry.sections != undefined)
                        {
                            const sectionsDiv = document.createElement('div');

                            const sectionsElement = document.createElement('ul');
                            sectionsElement.className = 'btn-toggle-nav list-unstyled fw-normal pb-1 small';
                            sectionsDiv.appendChild(sectionsElement);

                            entry.sections.forEach((section) => {
                                const sectionElement = document.createElement('li');

                                const link = document.createElement('a');
                                link.className = 'link-dark d-inline-flex text-decoration-none rounded section';
                                link.style.cursor = 'pointer';
                                link.href = '#' + section.hash;
                                sectionElement.appendChild(link);

                                const sectionSpan = document.createElement('span');
                                sectionSpan.className = 'p-1 mb-0';
                                sectionSpan.textContent = section.title;
                                link.appendChild(sectionSpan);

                                sectionsElement.appendChild(sectionElement);
                            });

                            entryElement.appendChild(sectionsDiv);
                        }

                        entriesElement.appendChild(entryElement);
                    }

                    let requirements = new Array();

                    if (category.requirements != null)
                        requirements = requirements.concat(category.requirements);

                    if (entry.requirements != null)
                        requirements = requirements.concat(entry.requirements);

                    let assets = {};

                    if (entry.assets != null)
                    {
                        if (entry.assets.robots != null)
                            assets.robots = entry.assets.robots;

                        if (entry.assets.scenes != null)
                            assets.scenes = entry.assets.scenes.map((x) => category.id + '/' + x);

                        if (entry.assets.scripts != null)
                            assets.scripts = entry.assets.scripts.map((x) => category.id + '/' + x);
                    }

                    pages.set(entry.hash, {
                        url: category.id + '/' + entry.page,
                        requirements: requirements,
                        assets: assets,
                    });
                });

                menu.appendChild(categoryElement);
            });

            if (url.hash != '')
                navigate(url.hash.substr(1));
            else
                navigate('home');
        }


        // Navigate to the specified page
        async function navigate(dest)
        {
            const dest_parts = dest.split('-');
            const page = dest_parts[0];
            const anchor = dest_parts.length == 2 ? dest_parts[1] : null;

            let pageEntry = pages.get(page);
            if (pageEntry == undefined)
                pageEntry = pages.get('home');

            const response = await fetch(baseUrl + '/' + pageEntry.url);
            if (!response.ok)
            {
                navigate('home');
                return;
            }

            if (document.cleanup != null)
            {
                await document.cleanup();
                document.cleanup = null;
            }

            if (btnSave != null)
            {
                btnSave.removeEventListener('click', saveCode);
                btnOpen.removeEventListener('click', loadCode);

                btnSave = null;
                btnOpen = null;
            }

            if (navlinks != null)
            {
                for (let navlink of navlinks)
                    navlink.removeEventListener('click', onTabChanged);

                navlinks = null;
            }

            currentPage = page;

            if (pageEntry.assets != null)
            {
                let robotsToLoad = [];
                let scenesToLoad = [];
                let scriptsToLoad = [];

                if (pageEntry.assets.robots != null)
                {
                    for (let robot of pageEntry.assets.robots)
                    {
                        if (loadedRobots.indexOf(robot) == -1)
                            robotsToLoad.push(robot);
                    }
                }

                if (pageEntry.assets.scenes != null)
                {
                    for (let scene of pageEntry.assets.scenes)
                    {
                        if (loadedScenes.indexOf(scene) == -1)
                            scenesToLoad.push(scene);
                    }
                }

                if (pageEntry.assets.scripts != null)
                {
                    for (let script of pageEntry.assets.scripts)
                    {
                        if (loadedScripts[script] == null)
                            scriptsToLoad.push(script);
                    }
                }

                if ((robotsToLoad.length > 0) || (scenesToLoad.length > 0) || (scriptsToLoad.length > 0))
                {
                    closeMenuButton.click();

                    const overlay = document.createElement('div');
                    overlay.id = 'pyscript_loading_splash';
                    overlay.className = 'py-overlay';
                    overlay.style.zIndex = 2000;

                    overlay.innerHTML = '<div class="py-pop-up">' +
                        '<div class="smooth spinner"></div>' +
                        '<div id="pyscript-loading-label" class="label">' +
                            '<div id="pyscript-operation-details">' +
                                '<p>Downloading assets...</p>' +
                            '</div>' +
                        '</div>' +
                    '</div>';

                    document.body.appendChild(overlay);

                    tasks.push(async () => {
                        for (let robot of robotsToLoad)
                        {
                            if (robot == "panda")
                                await downloadPandaRobot();

                            loadedRobots.push(robot);
                        }

                        for (let scene of scenesToLoad)
                        {
                            await downloadScene(scene);

                            loadedScenes.push(scene);
                        }

                        for (let script of scriptsToLoad)
                        {
                            const response = await fetch(baseUrl + '/' + script);
                            if (!response.ok)
                            {
                                navigate('home');
                                return;
                            }

                            loadedScripts[script] = await response.text();
                        }

                        document.getElementById('pyscript_loading_splash').remove();
                    });
                }
            }

            tasks.push(async () => {
                div.innerHTML = await response.text();
                closeMenuButton.click();
            });

            if (tasks.length == 1)
            {
                await tasks[0]();
                tasks.splice(0, 1);
            }

            tasks.push(async () => {
                convertMath();
            });

            tasks.push(async () => {
                spreadOutImages();

                if (page != 'home')
                {
                    if (anchor != null)
                        window.location.href = url.origin + url.pathname + '#' + page + '-' + anchor;
                    else
                        window.location.href = url.origin + url.pathname + '#' + page;
                }
                else
                {
                    window.location.href = url.origin + url.pathname + '#';
                }

                if (anchor == null)
                {
                    const anchor_element = document.getElementById('content')
                    anchor_element.scrollIntoView({
                        block: "start",
                        behavior: "instant"
                    });
                }

                pageEntry.requirements.forEach((requirement) => {
                    if (loadedRequirements[requirement])
                        return;

                    if (requirement == 'pyscript')
                        initPyScript();

                    loadedRequirements[requirement] = true;
                });

                btnOpen = document.getElementById('btn-open');
                btnSave = document.getElementById('btn-save');

                if (btnSave != null)
                {
                    btnSave.addEventListener('click', saveCode);
                    btnOpen.addEventListener('click', loadCode);

                    if (window.localStorage.getItem(getStorageKey()) != null)
                        btnOpen.style.display = 'inline';
                    else
                        btnOpen.style.display = 'none';

                    navlinks = document.getElementsByClassName('nav-link');
                    if (navlinks.length > 0)
                    {
                        for (let navlink of navlinks)
                            navlink.addEventListener('click', onTabChanged);
                    }
                    else
                    {
                        navlinks = null;
                    }
                }
            });

            executeNextTask();
        }


        function executeNextTask()
        {
            if (tasks.length > 0)
            {
                window.requestAnimationFrame(async (time) => {
                    const task = tasks.splice(0, 1)[0];
                    await task();
                    executeNextTask();
                });
            }
        }


        // Convert the LaTeX formulas into HTML
        function convertMath()
        {
            const elements = document.getElementsByClassName("ltx_Math");
            const macros = {
                '\\tp': '\\text{\\tiny{#1}}',
                '\\trsp' : '\\top',
                '\\psin' : '\\dagger',
                '\\eqref': '\\href{###1}{(\\text{#1})}',
                '\\ref': '\\href{###1}{\\text{#1}}',
                '\\label': '\\htmlId{#1}{}'
            };

            for (let element of elements) {
                katex.render(element.textContent, element, {
                    throwOnError: false,
                    macros
                });
            }

            renderMathInElement(document.body, {
                trust: (context) => ['\\htmlId', '\\href'].includes(context.command),
                macros: macros,
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\begin{equation}', right: '\\end{equation}', display: true},
                    {left: '\\begin{equation*}', right: '\\end{equation*}', display: true},
                    {left: '\\begin{align}', right: '\\end{align}', display: true},
                    {left: '\\begin{align*}', right: '\\end{align*}', display: true},
                    {left: '\\begin{alignat}', right: '\\end{alignat}', display: true},
                    {left: '\\begin{gather}', right: '\\end{gather}', display: true},
                    {left: '\\begin{CD}', right: '\\end{CD}', display: true},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError : false
            });
        }


        // Online course: spread out the images vertically
        function spreadOutImages()
        {
            const style = document.getElementById('online-course-figures');
            if (style != undefined)
                style.remove();

            const txt_column = document.querySelector('#txt-col');
            const img_column = document.querySelector('#img-col');

            if ((txt_column != undefined) && (img_column != undefined))
            {
                let txt_height = txt_column.offsetHeight;
                let img_height = img_column.offsetHeight;

                let margin = 50;

                if (txt_height > img_height && screen.width >= 576) {
                    let nb_figures = document.querySelectorAll('.figure_main').length;
                    let computed_margin = (txt_height - img_height) / nb_figures;

                    if (computed_margin > margin) {
                        margin = computed_margin;
                    }
                }

                const style = document.createElement('style');
                style.id = 'online-course-figures';
                style.innerHTML = '.figure_main{ margin-top:' + Math.round(margin/2) + 'px; margin-bottom:' + Math.round(margin/2) + 'px; }';
                document.head.appendChild(style);
            }
        }


        function initPyScript()
        {
            // Process the importmap to avoid errors from PyScript
            const scripts = document.getElementsByTagName('script');
            for (let script of scripts) {
                if (script.type == 'importmap') {
                    const importmap = JSON.parse(script.innerText);
                    delete importmap['imports']['three/examples/jsm/'];
                    delete importmap['imports']['mujoco'];
                    script.innerText = JSON.stringify(importmap);
                    break;
                }
            }

            // Add the PyScript script to the document
            const script = document.createElement('script');
            script.src = 'https://pyscript.net/latest/pyscript.min.js';
            script.type = 'text/javascript';
            document.body.appendChild(script);
        }


        function clearMsgs()
        {
            const el = document.getElementById('errors');
            el.innerText = '';
        }

        function clearMsgsOutput()
        {
            const el = document.getElementById('output');
            el.innerText = '';
        }

        function getScript(name)
        {
            return loadedScripts[name];
        }


        function setEditorCode(editor, code)
        {
            let el = editor.querySelector("div.cm-content");
            if (el == null)
            {
                el = editor.querySelector("div.py-repl-editor div");
                el = el.shadowRoot.querySelector("div.cm-content");
            }

            el.replaceChildren();
            el.textContent = code;
        }


        function scheduleTask(fct)
        {
            tasks.push(fct);
        }


        globalThis.clearMsgs = clearMsgs;
        globalThis.clearMsgsOutput = clearMsgsOutput;
        globalThis.getScript = getScript;
        globalThis.setEditorCode = setEditorCode;
        globalThis.scheduleTask = scheduleTask;
        globalThis.executeNextTask = executeNextTask;


        function getStorageKey()
        {
            const dest = window.location.hash.substr(1);
            const dest_parts = dest.split('-');
            const page = dest_parts[0];

            let prefix = document.location.pathname.replace('index.html', '');

            let storage_key = prefix + ':' + page;

            const active_navlink = document.getElementsByClassName('nav-link active')[0];
            if (active_navlink != null)
                storage_key += '-' + active_navlink.getAttribute('data-bs-target').substr(1);

            return storage_key;
        }


        function getActiveEditor()
        {
            const active_navlink = document.getElementsByClassName('nav-link active')[0];
            if (active_navlink != null)
            {
                const navlink_target_id = active_navlink.getAttribute('data-bs-target').substr(1);
                const navlink_target = document.getElementById(navlink_target_id);
                return navlink_target.getElementsByTagName('py-repl')[0];
            }

            return document.getElementsByTagName('py-repl')[0];
        }


        function saveCode(event)
        {
            const editor = getActiveEditor();

            window.localStorage.setItem(getStorageKey(), editor.getPySrc());
            btnOpen.style.display = 'inline';
        }


        function loadCode(event)
        {
            setEditorCode(
                getActiveEditor(),
                window.localStorage.getItem(getStorageKey()),
            );
        }


        function onTabChanged(event)
        {
            if (window.localStorage.getItem(getStorageKey()) != null)
                btnOpen.style.display = 'inline';
            else
                btnOpen.style.display = 'none';
        }


        window.onorientationchange = spreadOutImages;

        window.onhashchange = function() {
            const dest = window.location.hash.substr(1);
            const dest_parts = dest.split('-');
            const page = dest_parts[0];

            if (page != currentPage)
                navigate(dest);
        }

        initMenu();
        initViewer3D();
    </script>

</body>
</html>
