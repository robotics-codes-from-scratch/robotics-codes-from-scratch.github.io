<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="RCFS" name="description"/>
<meta content="robotics codes, robotics tutorial, rcfs, robotics from scratch" name="keywords"/>
<meta content="Sylvain Calinon" name="author"/>
<title>RCFS</title>
<link href="static_images/favicon.ico" rel="icon" sizes="any"/>
<link href="static_images/favicon.svg" rel="icon" type="image/svg+xml"/>
<link href="css/bootstrap.min.css" rel="stylesheet"/>
<link href="css/bootstrap-icons-1.10.4/font/bootstrap-icons.css" rel="stylesheet"/>
<link href="css/permanent_marker.css" rel="stylesheet"/>
<link href="css/sidebars.css" rel="stylesheet"/>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script defer="" src="https://pyscript.net/latest/pyscript.min.js"></script>
<py-config type="toml">
		packages = ['numpy']
	</py-config>
<link href="https://pyscript.net/latest/pyscript.css" rel="stylesheet"/> <!-- pyscript.css is incompatible with hypothes.is/embed.js-->
<link href="css/main-template.css" rel="stylesheet"/>
</head>
<body><nav aria-label="Light offcanvas navbar" class="navbar fixed-top" style="width: 50px;">
<div class="container-fluid">
<button aria-controls="offcanvasNavbarLight" class="navbar-toggler" data-bs-target="#offcanvasNavbarLight" data-bs-toggle="offcanvas" type="button">
<span class="navbar-toggler-icon" style="cursor: pointer;"></span>
</button>
<div aria-labelledby="offcanvasNavbarLightLabel" class="offcanvas offcanvas-start" id="offcanvasNavbarLight" style="width: 500px;" tabindex="-1">
<div class="offcanvas-header"><!--style='height: 50px;'-->
<a class="navbar-brand" href="index.html"><h4 class="offcanvas-title" id="offcanvasNavbarLightLabel"><i class="bi bi-robot"></i> <i class="bi bi-code-slash"></i> RCFS</h4></a>
<button aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button"></button>
</div>
<div class="offcanvas-body">
<!--Menu goes here-->
<ul class="list-unstyled ps-0">
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#general-collapse" data-bs-toggle="collapse">General information</button>
<div class="collapse show" id="general-collapse">
<!--<li><a href='index.html' class='link-dark d-inline-flex text-decoration-none rounded'>Home</a></li>-->
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="about.html">
<div class="p-1 mb-0">About</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#sandboxes2d-collapse" data-bs-toggle="collapse">2D sandboxes</button>
<div class="collapse" id="sandboxes2d-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_FK.html">
<div class="p-1 mb-0">Forward kinematics (FK)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_IK.html">
<div class="p-1 mb-0">Inverse kinematics (IK)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_bimanual.html">
<div class="p-1 mb-0">Bimanual robot</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_humanoid.html">
<div class="p-1 mb-0">Humanoid robot (CoM and coordination matrix)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR.html">
<div class="p-1 mb-0">Iterative linear quadratic regulator (iLQR)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR_car.html">
<div class="p-1 mb-0">iLQR for car</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR_bicopter.html">
<div class="p-1 mb-0">iLQR for bicopter</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#sandboxes3d-collapse" data-bs-toggle="collapse">3D sandboxes</button>
<div class="collapse" id="sandboxes3d-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox3d_IK.html">
<div class="p-1 mb-0">Inverse kinematics (IK)</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#exercises-collapse" data-bs-toggle="collapse">Exercises</button>
<div class="collapse" id="exercises-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise01.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">01</div>
<div class="p-1 mb-0">Linear algebra in Python</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise02.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">02</div>
<div class="p-1 mb-0">Movement primitives and Newton's method</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise03.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">03</div>
<div class="p-1 mb-0">Gaussian Distributions</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise04a.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">4a</div>
<div class="p-1 mb-0">Forward kinematics</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise04b.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">4b</div>
<div class="p-1 mb-0">Inverse kinematics and nullspace control</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise05a.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">5a</div>
<div class="p-1 mb-0">Forward dynamics</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise05b.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">5b</div>
<div class="p-1 mb-0">Inverse dynamics and impedance control</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise06a.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">6a</div>
<div class="p-1 mb-0">Planning with linear quadratic regulator</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise06b.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">6b</div>
<div class="p-1 mb-0">Planning in joint space with LQR</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise07.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">07</div>
<div class="p-1 mb-0">Iterative linear quadratic regulator (iLQR)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise08.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">08</div>
<div class="p-1 mb-0">Exploration with ergodic control</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise09.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">09</div>
<div class="p-1 mb-0">Orientation with Riemannian manifold</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#doc-collapse" data-bs-toggle="collapse">Online courses</button>
<div class="collapse" id="doc-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small" id="menu_container">
<li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S1.html" style="font-weight:bold;">1 Introduction</a></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html" style="font-weight:bold;">2 Newton’s method for minimization</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:GaussNewton"><span class="p-1 mb-0">2.1 Gauss–Newton algorithm</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:LS"><span class="p-1 mb-0">2.2 Least squares</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:LSconstraints"><span class="p-1 mb-0">2.3 Least squares with constraints</span></a></li></ul></div></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S3.html" style="font-weight:bold;">3 Forward kinematics (FK) for a planar robot manipulator</a></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html" style="font-weight:bold;">4 Inverse kinematics (IK) for a planar robot manipulator</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html#sec:IKnum"><span class="p-1 mb-0">4.1 Numerical estimation of the Jacobian</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html#sec:IK_nullspace"><span class="p-1 mb-0">4.2 Inverse kinematics (IK) with task prioritization</span></a></li></ul></div></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html" style="font-weight:bold;">5 Encoding with basis functions</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS1"><span class="p-1 mb-0">5.1 Univariate trajectories</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS2"><span class="p-1 mb-0">5.2 Multivariate trajectories</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS3"><span class="p-1 mb-0">5.3 Multidimensional inputs</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS4"><span class="p-1 mb-0">5.4 Derivatives</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS5"><span class="p-1 mb-0">5.5 Concatenated basis functions</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS6"><span class="p-1 mb-0">5.6 Batch computation of basis functions coefficients</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS7"><span class="p-1 mb-0">5.7 Recursive computation of basis functions coefficients</span></a></li></ul></div></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html" style="font-weight:bold;">6 Linear quadratic tracking (LQT)</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#SS1"><span class="p-1 mb-0">6.1 LQT with smoothness cost</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#SS2"><span class="p-1 mb-0">6.2 LQT with control primitives</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:LQRrecursive"><span class="p-1 mb-0">6.3 LQR with a recursive formulation</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:augmState"><span class="p-1 mb-0">6.4 LQT with a recursive formulation and an augmented state space</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:LQRLS"><span class="p-1 mb-0">6.5 Least squares formulation of recursive LQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:DMPLQT"><span class="p-1 mb-0">6.6 Dynamical movement primitives (DMP) reformulated as LQT with control primitives</span></a></li></ul></div></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html" style="font-weight:bold;">7 iLQR optimization</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRbatch"><span class="p-1 mb-0">7.1 Batch formulation of iLQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRrecursive"><span class="p-1 mb-0">7.2 Recursive formulation of iLQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRLS"><span class="p-1 mb-0">7.3 Least squares formulation of recursive iLQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS4"><span class="p-1 mb-0">7.4 Updates by considering step sizes</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS5"><span class="p-1 mb-0">7.5 iLQR with quadratic cost on f(x_{t})</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS6"><span class="p-1 mb-0">7.6 iLQR with control primitives</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS7"><span class="p-1 mb-0">7.7 iLQR for spacetime optimization</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS8"><span class="p-1 mb-0">7.8 iLQR with offdiagonal elements in the precision matrix</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS9"><span class="p-1 mb-0">7.9 Car steering</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS10"><span class="p-1 mb-0">7.10 Bicopter</span></a></li></ul></div></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S8.html" style="font-weight:bold;">8 Forward dynamics (FD) for a planar robot manipulator</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S8.html#SS1"><span class="p-1 mb-0">8.1 Robot manipulator with dynamics equation</span></a></li></ul></div></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="bib.html" style="font-weight:bold;">References</a></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A1.html" style="font-weight:bold;">A System dynamics at trajectory level</a></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A2.html" style="font-weight:bold;">B Derivation of motion equation for a planar robot</a></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A3.html" style="font-weight:bold;">C Linear systems used in the bimanual tennis serve example</a></li><li class="mb-1"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A4.html" style="font-weight:bold;">D Equivalence between LQT and LQR with augmented state space</a></li></ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</nav>
<div class="container-fluid">
<div class="row">
<div class="col-sm-1"></div>
<div class="col-sm-7">
<br/><br/>
<script>
function clearMsgs() {
  const el = document.getElementById('repl-err');
  el.innerText = '';
  //console.log('event!');
}
</script>
<div onclick="clearMsgs()" onkeydown="clearMsgs()">
<py-repl std-err="repl-err" std-out="repl-out">
# Precision matrix
Q = np.diag([1., 1., 0, 0,  1., 1., 0, 0])
update_iLQR()
</py-repl> <!--output='repl-out' std-out='repl-out'-->
</div>
<p id="repl-out" style="font-size: 70%; color: #777777;">(click on the green run button to run the code; objects and joints can be moved with the mouse)</p>
<p id="repl-err" style="font-size: 70%; color: #880000;"></p>
<form>
<div class="row">
<div class="col-md"><label>Car 1 orientation</label><input class="w-72" id="car_angle0" max="3.14159" min="-3.14159" oninput="this.nextElementSibling.value = this.value" step="0.0001" style="vertical-align:middle;" type="range" value="0"/> <output>0.0</output></div>
<div class="col-md"><label>Car 2 orientation</label><input class="w-72" id="car_angle1" max="3.14159" min="-3.14159" oninput="this.nextElementSibling.value = this.value" step="0.0001" style="vertical-align:middle;" type="range" value="1.57079"/> <output>1.57079</output></div>
</div>
<div class="row">
<div class="col-md"><label>Wheels 1 orientation</label><input class="w-72" id="wheels_angle0" max="1.57079" min="-1.57079" oninput="this.nextElementSibling.value = this.value" step="0.0001" style="vertical-align:middle;" type="range" value="0"/> <output>0.0</output></div>
<div class="col-md"><label>Wheels 2 orientation</label><input class="w-72" id="wheels_angle1" max="1.57079" min="-1.57079" oninput="this.nextElementSibling.value = this.value" step="0.0001" style="vertical-align:middle;" type="range" value="0"/> <output>0.0</output></div>
</div>
<div class="row">
<div class="col-md"><label>Simulation speed</label><input class="w-72" id="simulation_speed" max="20" min="0" oninput="this.nextElementSibling.value = this.value" step="0.01" style="vertical-align:middle;" type="range" value="10"/> <output>10.0</output></div>
</div>
<div class="row">
<div class="col-md"><label>Cost</label><span id="cost"></span></div>
</div>
</form>
</div> <!--sm-7-->
<div class="col-sm-4">
<div class="sticky-sm-top">
<canvas height="700px" id="canvas" style="width:100%;" width="900px"></canvas>
</div>
</div> <!--sm-4-->
</div> <!--row-->
<py-script>
from pyodide.ffi import create_proxy
from js import Path2D, document, console
import numpy as np
import asyncio

#########################################################################################
car_svg = Path2D.new('m -4.9070956,-15.985104 c -1.103,0 -2,0.897 -2,2 v 0.4375 c 1.328,0.583 2.324,1.721 2.75,3.125 0.167,0.252 0.25,0.6824985 0.25,1.4374985 v 2.0000001 h 2.99999996 v 1 H 1.0929044 v -1 h 2 c 1.103,0 2,-0.897 2,-2.0000001 v -4.9999985 c 0,-1.103 -0.897,-2 -2,-2 z m -6.0000004,4 c -0.552,0 -1,0.448 -1,1 v 22 c 0,0.553 0.448,1 1,1 h 2.0000004 c 1.654,0 3,-1.346 3,-3.0000014 V -8.9851055 c 0,-1.6539985 -1.346,-2.9999985 -3,-2.9999985 z m 44,0 c -0.553,0 -1,0.448 -1,1 v 4.6249986 c 3.242,0.617 5.80475,1.47625 5.96875,1.53125 0.016,0.005 0.01625,0.02625 0.03125,0.03125 v -6.1874986 c 0,-0.552 -0.447,-1 -1,-1 z M 8.0929044,-9.9851045 c -0.351,0 -0.66375,0.198999 -0.84375,0.499999 l -2.71875,4.5000001 h -8.4375 v 10 h 8.4375 l 2.71875,4.5 c 0.18,0.3 0.49275,0.5000004 0.84375,0.5000004 h 6.9999996 c 0.208,0 0.42475,-0.0655 0.59375,-0.1875004 l 6.71875,-4.8125 h 3.6875 c 5.05,0 11.0605,-1.9785 11.3125,-2.0625 0.411,-0.135 0.6875,-0.5055 0.6875,-0.9375 v -4 c 0,-0.43 -0.2795,-0.8005 -0.6875,-0.9375 -0.249,-0.084 -6.1555,-2.0625 -11.3125,-2.0625 h -3.6875 l -6.71875,-4.8125001 c -0.169,-0.121 -0.38575,-0.187499 -0.59375,-0.187499 z m 1.9999996,6.9999991 h 5 c 1.657,0 3,1.343 3,3.00000008 0,1.65699992 -1.343,2.99999992 -3,2.99999992 h -5 z m 28,7.8125 c -0.019,0.007 -0.0435,0.02525 -0.0625,0.03125 -0.167,0.055 -2.7185,0.885 -5.9375,1.5 v 4.6562514 c 0,0.553 0.447,1 1,1 h 4 c 0.553,0 1,-0.447 1,-1 z m -38.99999964,1.1875 v 1 H -3.9070956 v 2 c 0,0.496 -0.02575,0.809 -0.09375,1.0000004 -0.326,1.610001 -1.43725,2.918501 -2.90625,3.562501 v 0.4375 c 0,1.105 0.895,2 2,2 h 8 c 1.105,0 2,-0.895 2,-2 V 9.0148946 c 0,-1.105 -0.895,-2 -2,-2 h -2 v -1 z')
lwheel_svg = Path2D.new('m -3.4996449,-4.4958081 c -1.103,0 -2,0.897 -2,2 v 3.9999985 c 0,1.1030001 0.897,2.0000001 2,2.0000001 h 1 v 1 h 2.00000015 v -1 h 1 v 1 H 2.5003551 v -1 h 1 c 1.103,0 2,-0.897 2,-2.0000001 v -3.9999985 c 0,-1.103 -0.897,-2 -2,-2 z')
rwheel_svg = Path2D.new('m -2.49522,-4.4785246 v 1 h -1 c -1.103,0 -2,0.897 -2,2 v 4.000001 c 0,1.103 0.897,2 2,2 h 7 c 1.103,0 2,-0.897 2,-2 v -4.000001 c 0,-1.103 -0.897,-2 -2,-2 h -1 v -1 H 0.50477997 v 1 h -1 v -1 z')

# computer the transfer matrix of the linearized system
def transferMatrices(A, B):
    nbVarX, nbVarU, nbData = B.shape
    nbData += 1
    Sx = np.kron(np.ones((nbData, 1)), np.identity(nbVarX))
    Su = np.zeros((nbVarX * (nbData), nbVarU * (nbData-1)))
    for t in range(nbData-1):
        id1 = np.arange(t*nbVarX, (t+1)*nbVarX, 1, dtype=int) # 012, 345, ...
        id2 = np.arange((t+1)*nbVarX, (t+2)*nbVarX, 1, dtype=int) # 345, 678, ...
        id3 = np.arange(t*nbVarU, (t+1)*nbVarU, 1, dtype=int) # 012, 345, ...
        Sx[id2, :] = np.matmul(A[:, :, t], Sx[id1, :])
        Su[id2, :] = np.matmul(A[:, :, t], Su[id1, :])
        Su[(t+1)*nbVarX : (t+2)*nbVarX, t*nbVarU : (t+1)*nbVarU] = B[:, :, t]
    return Su, Sx

# Given the control trajectory u and initial state x0, compute the whole state trajectory
def dynSysSimulation(x0, u, model):
    x = np.zeros([model.nbVarX, model.nbData])
    dx = np.zeros(param.nbVarX)
    x[:,0] = x0
    for t in range(param.nbData-1):
        dx[0] = np.cos(x[2,t]) * u[0,t]
        dx[1] = np.sin(x[2,t]) * u[0,t]
        dx[2] = np.tan(x[3,t]) * u[0,t] / param.l
        dx[3] = u[1,t]
        x[:,t+1] = x[:,t] + dx * param.dt
    return x

# Linearize the system along the trajectory computing the matrices A and B
def linSys(x, u, param):
    A = np.zeros([param.nbVarX, param.nbVarX, param.nbData-1])
    B = np.zeros([param.nbVarX, param.nbVarU, param.nbData-1])
    Ac = np.zeros([param.nbVarX, param.nbVarX])
    Bc = np.zeros([param.nbVarX, param.nbVarU])
    for t in range(param.nbData-1):
        # Linearize the system
        Ac[0,2] = -u[0,t] * np.sin(x[2,t])
        Ac[1,2] = u[0,t] * np.cos(x[2,t])
        Ac[2,3] = u[0,t] * np.tan(x[3,t]**2+1) / param.l
        Bc[0,0] = np.cos(x[2,t])
        Bc[1,0] = np.sin(x[2,t])
        Bc[2,0] = np.tan(x[3,t]) / param.l
        Bc[3,1] = 1
        # Discretize the linear system
        A[:,:,t] = np.eye(param.nbVarX) + Ac * param.dt
        B[:,:,t] = Bc * param.dt
    return A, B

# iLQR in batch form
def iLQR(x0, u, param):
	for i in range(param.nbIter):
		# System evolution
		x = dynSysSimulation(x0, u.reshape([param.nbVarU, param.nbData-1], order='F'), param)
		# Linearization
		A, B = linSys(x, u.reshape([param.nbVarU, param.nbData-1], order='F'), param)
		Su0, _ = transferMatrices(A, B)
		Su = Su0[idx,:]
		# Gauss-Newton update
		e = x[:,tl].flatten('F') - param.Mu.flatten('F')
		du = np.linalg.inv(Su.T @ Q @ Su + R) @ (-Su.T @ Q @ e - R @ u)
		# Estimate step size with backtracking line search method
		alpha = 1
		cost0 = e.T @ Q @ e + u.T @ R @ u
		while True:
		    utmp = u + du * alpha
		    xtmp = dynSysSimulation(x0, utmp.reshape([param.nbVarU, param.nbData-1], order='F'), param)
		    etmp = xtmp[:,tl].flatten('F') - param.Mu.flatten('F')
		    cost = etmp.T @ Q @ etmp + utmp.T @ R @ utmp

		    if cost &lt; cost0 or alpha &lt; 1e-3:
		        u = utmp
		        break
		    alpha /= 2
		if np.linalg.norm(alpha * du) &lt; 1e-2: # Early stop condition
		    break
	return x, u, cost


def update_iLQR():
	global param, x, u, cost_el
	for i in range(param.nbPoints):
		param.Mu[2,i] = float(car_angles[i].value) # Car i orientation
		param.Mu[3,i] = float(wheels_angles[i].value) # Wheels i orientation
	u = np.zeros(param.nbVarU * (param.nbData-1)) # Reinitialize control commands (optional)
	x, u, cost = iLQR(x0, u, param)
	cost_el.textContent = '%.3f' % cost


## Parameters
# ===============================

param = lambda: None # Lazy way to define an empty class in python
param.dt = 1E-1 # Time step length
param.nbData = 100 # Number of datapoints
param.nbIter = 30 # Maximum number of iterations for iLQR
param.nbPoints = 2 # Number of viapoints
param.nbVarX = 4 # State space dimension (x1,x2,theta,phi)
param.nbVarU = 2 # Control space dimension (v,dphi)
param.l = .25 # Length of the car
param.q = 1E0 # Precision weight
param.r = 1E-6 # Control weight term
param.Mu = np.array([[2., .5, 0, 0], [1., -1., np.pi/2, 0]]).T # Viapoints (x1,x2,theta,phi)
#param.Mu = np.array([[2., .5, 0, 0]]).T # Single viapoint (x1,x2,theta,phi)

Q = np.identity(param.nbVarX * param.nbPoints) * param.q # Precision matrix
R = np.identity((param.nbData-1) * param.nbVarU) * param.r # Control weight matrix

# Time occurrence of viapoints
tl = np.linspace(0, param.nbData, param.nbPoints+1)
tl = np.rint(tl[1:]).astype(np.int64) - 1
idx = np.array([i + np.arange(0,param.nbVarX,1) for i in (tl*param.nbVarX)]).flatten()

#########################################################################################

# GUI
scaling_factor = 2 # General scaling factor for rendering
scaling_coord = 100 # Scaling factor for car coordinates

# Mouse events
mouse0 = np.zeros(2)
mouse = np.zeros(2)
mousedown = 0

def onMouseMove(event):
	global mouse, mouse0
	offset = canvas.getBoundingClientRect()
	mouse0[0] = (event.clientX - offset.x) * canvas.width / canvas.clientWidth
	mouse0[1] = (event.clientY - offset.y) * canvas.width / canvas.clientWidth
	mouse[0] = (mouse0[0] - canvas.width * 0.1) / scaling_factor
	mouse[1] = -(mouse0[1] - canvas.height * 0.5) / scaling_factor

def onTouchMove(event):
	global mouse, mouse0
	bcr = event.target.getBoundingClientRect()
	mouse0[0] = event.touches.item(0).clientX - bcr.x
	mouse0[1] = event.touches.item(0).clientY - bcr.y
	mouse[0] = (mouse0[0] - canvas.width * 0.1) / scaling_factor
	mouse[1] = -(mouse0[1] - canvas.height * 0.5) / scaling_factor

def onMouseDown(event):
	global mousedown, hover0
	mousedown = 1

def onMouseUp(event):
	global mousedown, selected_obj
	mousedown = 0
	selected_obj = -1
	update_iLQR()

def onWheel(event):
	global hover_obj, car_angles
	#if mousedown==1:
	#document.getElementById('object0_angle').value = str(param.Mu[2,0] + 0.2 * (event.deltaY/106))
	if hover_obj &gt;= 0:
		car_angles[hover_obj].value = float(car_angles[hover_obj].value) + 0.2 * (event.deltaY/106)
		update_iLQR()

cost_el = document.getElementById('cost')

document.addEventListener('mousemove', create_proxy(onMouseMove)) #for standard mouse
document.addEventListener('touchmove', create_proxy(onTouchMove)) #for mobile interfaces

document.addEventListener('mousedown', create_proxy(onMouseDown)) #for standard mouse
#document.addEventListener('pointerdown', create_proxy(onMouseDown)) #for mobile interfaces
document.addEventListener('touchstart', create_proxy(onMouseDown)) #for mobile interfaces

document.addEventListener('mouseup', create_proxy(onMouseUp)) #for standard mouse
#document.addEventListener('pointerup', create_proxy(onMouseUp)) #for mobile interfaces
document.addEventListener('touchend', create_proxy(onMouseUp)) #for mobile interfaces

document.addEventListener('wheel', create_proxy(onWheel)) #for standard mouse

#########################################################################################

canvas = document.getElementById('canvas')
ctx = canvas.getContext('2d')

car_angles = []
wheels_angles = []
for i in range(param.nbPoints):
	car_angles.append(document.getElementById('car_angle%d' % i))
	wheels_angles.append(document.getElementById('wheels_angle%d' % i))

simulation_speed = document.getElementById('simulation_speed') # Simulation speed
selected_obj = -1

def clear_screen():
	ctx.setTransform(1, 0, 0, 1, 0, 0) # Reset transformation to identity
	ctx.fillStyle = 'white'
	ctx.fillRect(0, 0, canvas.width, canvas.height)


def draw_car(x, color='#000000', selectable='False', id=0):
	global selected_obj, hover_obj
	ctx.setTransform(scaling_factor, 0, 0, -scaling_factor, canvas.width*0.1, canvas.height*0.5) # Reset transformation
	offset = 0

	ctx.translate(x[0]*scaling_coord, x[1]*scaling_coord)
	ctx.rotate(x[2])

	ctx.fillStyle = color
#	ctx.strokeStyle = color2
	ctx.save()
	ctx.translate(-offset, 0)
	ctx.fill(car_svg)
	if selectable=='True':
		if ctx.isPointInPath(car_svg, mouse0[0], mouse0[1]):
			hover_obj = id
		if ctx.isPointInPath(car_svg, mouse0[0], mouse0[1]) and mousedown==1:
			selected_obj = id

#	ctx.stroke(car_svg)
	ctx.restore()

	#Left wheel
	ctx.save()
	ctx.translate(25-offset, -11.2)
	ctx.rotate(x[3])
#	ctx.fillStyle = '#008800'
	ctx.fill(lwheel_svg)
#	ctx.stroke(lwheel_svg)
	ctx.restore()

	#Right wheel
	ctx.save()
	ctx.translate(25-offset, 11.2)
	ctx.rotate(x[3])
#	ctx.fillStyle = '#000088'
	ctx.fill(rwheel_svg)
#	ctx.stroke(rwheel_svg)
	ctx.restore()

#	ctx.strokeStyle = '#FFFFFF'
#	ctx.beginPath()
#	ctx.moveTo(0,0)
#	ctx.lineTo(25,0)
#	ctx.stroke()


#########################################################################################

x0 = np.zeros(param.nbVarX) # Initial state
u = np.zeros(param.nbVarU * (param.nbData-1)) # Initial control commands
x, u, cost = iLQR(x0, u, param)
cost_el.textContent = '%.3f' % cost

async def main():
	global hover_obj, param

	t0 = 0
	t = 0
	tf = 0
	while True:
		t0 += float(simulation_speed.value)
		if t0 &gt; 19:
			t0 = 0
			if t &gt; param.nbData-2:
				tf += 1
				if tf &gt; 10: #Stay some iterations at the final point before starting again
					t = 0
					tf = 0
			else:
				t += 1

		# Reinit hovering variables
		hover_obj = -1

		# Rendering
		clear_screen()
		draw_car(x0, '#CCCCCC')
		draw_car(param.Mu[:,0], '#FF3399', 'True', 0)
		draw_car(param.Mu[:,1], '#33FF99', 'True', 1)
		draw_car(x[:,t])

		# Car selection
		if selected_obj &gt;= 0:
			param.Mu[:2,selected_obj] = mouse
			param.Mu[0,selected_obj] = max(min(param.Mu[0,selected_obj],225*1.8), -225*0.1) / scaling_coord
			param.Mu[1,selected_obj] = max(min(param.Mu[1,selected_obj],175), -175) / scaling_coord

		await asyncio.sleep(0.0001)

pyscript.run_until_complete(main())

</py-script>
</div> <!--container-->
</body>
</html>
