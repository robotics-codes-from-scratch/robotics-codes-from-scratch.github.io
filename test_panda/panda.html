<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js using an URDF robot</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <link rel='stylesheet' href='https://pyscript.net/latest/pyscript.css'>
    <script defer src='https://pyscript.net/latest/pyscript.js'></script>
</head>


<body>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.141.0/build/three.module.js",
                "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.141.0/examples/jsm/",
                "xacro-parser": "https://cdn.jsdelivr.net/npm/xacro-parser@0.3.1/src/index.js",
                "urdf-loader": "https://cdn.jsdelivr.net/npm/urdf-loader@0.10.4/src/URDFLoader.js",
                "expr-eval": "https://cdn.jsdelivr.net/npm/expr-eval@2.0.2/dist/index.mjs"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        import { loadRobot } from './src/loader.js';

        // In ROS models Z points upwards
        THREE.Object3D.DefaultUp = new THREE.Vector3(0, 0, 1);

        let camera, scene, renderer;
        
        loadRobot()
            .then(robot => {
                document.robot = robot;
                
                init(robot);
                animate();
        })


        function init(robot) {
            let container = document.createElement( 'div' );
            document.body.appendChild( container );

            camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
        	camera.position.set(8, 20, 10);
        	camera.lookAt(0, 0, 5);

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x363b4b);

            // Grid
            const grid = new THREE.GridHelper( 20, 20, 0x888888, 0x444444 );
        	grid.rotateX(Math.PI / 2);
            scene.add( grid );

            // Add the robot
            scene.add( robot.model );

            // Lights
            const light = new THREE.HemisphereLight( 0xffeeee, 0x111122 );
            scene.add( light );

        	const pointLight = new THREE.PointLight(0xffffff, 0.3);
        	pointLight.position.set(30, 30, 40);
        	scene.add(pointLight);

            renderer = new THREE.WebGLRenderer();
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.setPixelRatio( window.devicePixelRatio );
            renderer.setSize( window.innerWidth, window.innerHeight );
            container.appendChild( renderer.domElement );

            window.addEventListener( 'resize', onWindowResize );
        }


        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );
        }


        function animate() {
            requestAnimationFrame( animate );
            renderer.render( scene, camera );
        }
</script>


<py-script>
    from js import document
    import math
    import asyncio


    async def main():
        t = 0
        
        pose = document.robot.getPose()
        
        while True:
            pose[2] = math.sin(2 * math.pi * t)
            pose[4] = math.sin(2 * math.pi * t / 2)
            document.robot.setPose(pose)

            await asyncio.sleep(0.0001)
            t += 0.001

    pyscript.run_until_complete(main())
</py-script>

</body>
</html>
