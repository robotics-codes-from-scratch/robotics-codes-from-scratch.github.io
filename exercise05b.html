<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="RCFS" name="description"/>
<meta content="robotics codes, robotics tutorial, rcfs, robotics from scratch" name="keywords"/>
<meta content="Sylvain Calinon" name="author"/>
<title>RCFS</title>
<link href="static_images/favicon.ico" rel="icon" sizes="any"/>
<link href="static_images/favicon.svg" rel="icon" type="image/svg+xml"/>
<link href="css/bootstrap.min.css" rel="stylesheet"/>
<link href="css/bootstrap-icons-1.10.4/font/bootstrap-icons.css" rel="stylesheet"/>
<link href="css/permanent_marker.css" rel="stylesheet"/>
<link href="css/sidebars.css" rel="stylesheet"/>
<link href="css/katex.min.css" rel="stylesheet"/>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/katex.min.js"></script>
<script>

		function initialize(){
			convertMath();
		}

		function convertMath(){
			const elements = document.getElementsByClassName("ltx_Math");
			const macros = {
				'\\tp': '\\text{\\tiny{#1}}',
				'\\trsp' : '\\top',
				'\\psin' : '\\dagger',
				'\\eqref': '\\href{###1}{(\\text{#1})}',
				'\\ref': '\\href{###1}{\\text{#1}}',
				'\\label': '\\htmlId{#1}{}'
			};
			for(let element of elements){
				katex.render(element.textContent, element, {
					throwOnError: false,
					macros
				});
			}
		}

		window.onload = initialize;
	</script>
<script defer="" src="https://pyscript.net/latest/pyscript.min.js"></script>
<py-config type="toml">
		packages = ['numpy']
	</py-config>
<link href="https://pyscript.net/latest/pyscript.css" rel="stylesheet"/> <!-- pyscript.css is incompatible with hypothes.is/embed.js-->
<link href="css/main-template.css" rel="stylesheet"/>
</head>
<body><nav aria-label="Light offcanvas navbar" class="navbar fixed-top" style="width: 50px;">
<div class="container-fluid">
<button aria-controls="offcanvasNavbarLight" class="navbar-toggler" data-bs-target="#offcanvasNavbarLight" data-bs-toggle="offcanvas" type="button">
<span class="navbar-toggler-icon" style="cursor: pointer;"></span>
</button>
<div aria-labelledby="offcanvasNavbarLightLabel" class="offcanvas offcanvas-start" id="offcanvasNavbarLight" style="width: 500px;" tabindex="-1">
<div class="offcanvas-header"><!--style='height: 50px;'-->
<a class="navbar-brand" href="index.html"><h4 class="offcanvas-title" id="offcanvasNavbarLightLabel"> <i class="bi bi-code-slash"></i> RCFS</h4></a>
<button aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button"></button>
</div>
<div class="offcanvas-body">
<!--Menu goes here-->
<ul class="list-unstyled ps-0">
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#general-collapse" data-bs-toggle="collapse">General information</button>
<div class="collapse show" id="general-collapse">
<!--<li><a href='index.html' class='link-dark d-inline-flex text-decoration-none rounded'>Home</a></li>-->
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="about.html">
<div class="p-1 mb-0">About</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#sandboxes2d-collapse" data-bs-toggle="collapse">2D sandboxes</button>
<div class="collapse" id="sandboxes2d-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_FK.html">
<div class="p-1 mb-0">Forward kinematics (FK)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_IK.html">
<div class="p-1 mb-0">Inverse kinematics (IK)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_bimanual.html">
<div class="p-1 mb-0">Bimanual robot</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_humanoid.html">
<div class="p-1 mb-0">Humanoid robot (CoM and coordination matrix)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR.html">
<div class="p-1 mb-0">Iterative linear quadratic regulator (iLQR)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR_car.html">
<div class="p-1 mb-0">iLQR for car</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR_bicopter.html">
<div class="p-1 mb-0">iLQR for bicopter</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#sandboxes3d-collapse" data-bs-toggle="collapse">3D sandboxes</button>
<div class="collapse" id="sandboxes3d-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox3d_IK.html">
<div class="p-1 mb-0">Inverse kinematics (IK)</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#exercises-collapse" data-bs-toggle="collapse">Exercises</button>
<div class="collapse" id="exercises-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise01.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">01</div>
<div class="p-1 mb-0">Linear algebra in Python</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise02.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">02</div>
<div class="p-1 mb-0">Movement primitives and Newton's method</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise03.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">03</div>
<div class="p-1 mb-0">Gaussian Distributions</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise04a.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">4a</div>
<div class="p-1 mb-0">Forward kinematics</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise04b.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">4b</div>
<div class="p-1 mb-0">Inverse kinematics and nullspace control</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise05a.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">5a</div>
<div class="p-1 mb-0">Forward dynamics</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise05b.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">5b</div>
<div class="p-1 mb-0">Inverse dynamics and impedance control</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise06a.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">6a</div>
<div class="p-1 mb-0">Planning with linear quadratic regulator</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise06b.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">6b</div>
<div class="p-1 mb-0">Planning in joint space with LQR</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise07.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">07</div>
<div class="p-1 mb-0">Iterative linear quadratic regulator (iLQR)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise08.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">08</div>
<div class="p-1 mb-0">Exploration with ergodic control</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise09.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">09</div>
<div class="p-1 mb-0">Orientation with Riemannian manifold</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#doc-collapse" data-bs-toggle="collapse">Online courses</button>
<div class="collapse" id="doc-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small" id="menu_container">
<li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="toc.html" style="font-weight:bold;">Table of contents</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S1.html" style="font-weight:bold;">1 Introduction</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html" style="font-weight:bold;">2 Newton’s method for minimization</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:GaussNewton"><span class="p-1 mb-0">2.1 Gauss–Newton algorithm</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:LS"><span class="p-1 mb-0">2.2 Least squares</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:LSconstraints"><span class="p-1 mb-0">2.3 Least squares with constraints</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S3.html" style="font-weight:bold;">3 Forward kinematics (FK) for a planar robot manipulator</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html" style="font-weight:bold;">4 Inverse kinematics (IK) for a planar robot manipulator</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html#sec:IKnum"><span class="p-1 mb-0">4.1 Numerical estimation of the Jacobian</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html#sec:IK_nullspace"><span class="p-1 mb-0">4.2 Inverse kinematics (IK) with task prioritization</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html" style="font-weight:bold;">5 Encoding with basis functions</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS1"><span class="p-1 mb-0">5.1 Univariate trajectories</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS2"><span class="p-1 mb-0">5.2 Multivariate trajectories</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS3"><span class="p-1 mb-0">5.3 Multidimensional inputs</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS4"><span class="p-1 mb-0">5.4 Derivatives</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS5"><span class="p-1 mb-0">5.5 Concatenated basis functions</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS6"><span class="p-1 mb-0">5.6 Batch computation of basis functions coefficients</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS7"><span class="p-1 mb-0">5.7 Recursive computation of basis functions coefficients</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html" style="font-weight:bold;">6 Linear quadratic tracking (LQT)</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#SS1"><span class="p-1 mb-0">6.1 LQT with smoothness cost</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#SS2"><span class="p-1 mb-0">6.2 LQT with control primitives</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:LQRrecursive"><span class="p-1 mb-0">6.3 LQR with a recursive formulation</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:augmState"><span class="p-1 mb-0">6.4 LQT with a recursive formulation and an augmented state space</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:LQRLS"><span class="p-1 mb-0">6.5 Least squares formulation of recursive LQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:DMPLQT"><span class="p-1 mb-0">6.6 Dynamical movement primitives (DMP) reformulated as LQT with control primitives</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html" style="font-weight:bold;">7 iLQR optimization</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRbatch"><span class="p-1 mb-0">7.1 Batch formulation of iLQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRrecursive"><span class="p-1 mb-0">7.2 Recursive formulation of iLQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRLS"><span class="p-1 mb-0">7.3 Least squares formulation of recursive iLQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS4"><span class="p-1 mb-0">7.4 Updates by considering step sizes</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS5"><span class="p-1 mb-0">7.5 iLQR with quadratic cost on f(x_{t})</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS6"><span class="p-1 mb-0">7.6 iLQR with control primitives</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS7"><span class="p-1 mb-0">7.7 iLQR for spacetime optimization</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS8"><span class="p-1 mb-0">7.8 iLQR with offdiagonal elements in the precision matrix</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS9"><span class="p-1 mb-0">7.9 Car steering</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS10"><span class="p-1 mb-0">7.10 Bicopter</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S8.html" style="font-weight:bold;">8 Forward dynamics (FD) for a planar robot manipulator</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S8.html#SS1"><span class="p-1 mb-0">8.1 Robot manipulator with dynamics equation</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="bib.html" style="font-weight:bold;">References</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A1.html" style="font-weight:bold;">A System dynamics at trajectory level</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A2.html" style="font-weight:bold;">B Derivation of motion equation for a planar robot</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A3.html" style="font-weight:bold;">C Linear systems used in the bimanual tennis serve example</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A4.html" style="font-weight:bold;">D Equivalence between LQT and LQR with augmented state space</a></li></ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</nav>
<div class="container-fluid">
<script>
function clearMsgs() {
  const el = document.getElementById('errors');
  el.innerText = '';
  //console.log('event!');
}
function clearMsgsOutput() {
  const el = document.getElementById('output');
  el.innerText = '';
  //console.log('event!');
}
const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b','#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];
</script>
<div class="row">
<div class="col-sm-1"></div>
<div class="col-sm-7">
<h1>Exercise 5.b<br/>Inverse dynamics and impedance control</h1>
<p>Inverse dynamics is the problem of computing the joint torques of a robot given its joint positions, velocities and accelerations: <span class="ltx_Math">\bm{\tau} = \bm{M}(\bm{q})\bm{\ddot{q}}+ \bm{C}(\bm{q},\bm{\dot{q}}) + \bm{g}(\bm{q})</span>.</p>
<p>The goal of this exercise is to understand the different terms in the inverse dynamics problem formulation and to control the robot to reach a desired position using <b>joint space impedance control</b>.</p>
<p>The function <code>inverse_dynamics(q, dq, ddq, param)</code> implements the inverse dynamics model for a planar manipulator. Its outputs are joint torques.</p>
<p>The function <code>controlCommand(state, param)</code> takes the current state of the robot <span class="ltx_Math">[\bm{q}, \bm{\dot{q}}]</span> as input and outputs joint torque commands <code>u</code> that are sent to the robot.
<p>
<ul class="list-group list-group-numbered">
<li class="list-group-item">
		Set the control commands as <span class="ltx_Math"> \bm{\tau} = \bm{g}(\bm{q})</span> by exploiting the function <code>inverse_dynamics(q, dq, ddq, param)</code> to compute the gravity compensation torques <span class="ltx_Math">\bm{g}(\bm{q})</span>. Perturb the robot with the mouse (at the articulations level) and observe the result of the perturbation.
	</li>
<li class="list-group-item">
		Set the control commands as <span class="ltx_Math"> \bm{\tau} = \bm{C}(\bm{q},\bm{\dot{q}}) + \bm{g}(\bm{q})</span>. Perturb the robot with the mouse and observe the result of the perturbation.
	</li>
<li class="list-group-item">
		We would like the robot to reach an upright position <code>q_target = np.array([np.pi/2, 0])</code> and stay there with zero velocity <code>dq_target = np.array([0, 0])</code>.
		Set the torque control commands to send to the robot so that the resulting closed-loop robot behavior corresponds to a mass-spring-damper system.
		You should see that it stabilizes around the upright position. To check how stable your controller is, try to perturb the robot with the mouse.
		Modify the values of stiffness and damping to see the effect of perturbations on the impedance controller.
	</li>
</ul><br/>
<ul class="nav nav-tabs" id="myTab" role="tablist">
<li class="nav-item" role="presentation">
<button aria-controls="question5-tab-pane" aria-selected="true" class="nav-link active" data-bs-target="#question5-tab-pane" data-bs-toggle="tab" id="question5-tab" role="tab" type="button">Questions</button>
</li>
<li class="nav-item" role="presentation"> <button aria-controls="answer1-tab-pane" aria-selected="false" class="nav-link" data-bs-target="#answer1-tab-pane" data-bs-toggle="tab" id="answer1-tab" role="tab" type="button">Answer 1</button>
</li>
<li class="nav-item" role="presentation"> <button aria-controls="answer2-tab-pane" aria-selected="false" class="nav-link" data-bs-target="#answer2-tab-pane" data-bs-toggle="tab" id="answer2-tab" role="tab" type="button">Answer 2</button>
</li>
<li class="nav-item" role="presentation"> <button aria-controls="answer3-tab-pane" aria-selected="false" class="nav-link" data-bs-target="#answer3-tab-pane" data-bs-toggle="tab" id="answer3-tab" role="tab" type="button">Answer 3</button>
</li>
</ul>
<div class="tab-content" id="myTabContent">
<div aria-labelledby="question5-tab" class="tab-pane fade show active" id="question5-tab-pane" role="tabpanel" tabindex="0">
<py-repl std-err="errors" std-out="output">
q_target = np.array([np.pi/2, 0])
dq_target = np.array([0, 0])
Kp = 10
Kv = 1
def controlCommand(state, param):
  # Question 1: Gravity Compensation Term (g(q))
  q = np.zeros(param.nbVarX)   # Implement here
  dq = np.zeros(param.nbVarX)  # Implement here
  ddq = np.zeros(param.nbVarX) # Implement here
  u = inverse_dynamics(q, dq, ddq, param)

  # Question 2: Gravity compensation and Coriolis terms (c(q,dq) + g(q))
  q = np.zeros(param.nbVarX)   # Implement here
  dq = np.zeros(param.nbVarX)  # Implement here
  ddq = np.zeros(param.nbVarX) # Implement here
  u = inverse_dynamics(q, dq, ddq, param)

  # Question 3: Joint impedance control for reaching upright position
  q = np.zeros(param.nbVarX)   # Implement here
  dq = np.zeros(param.nbVarX)  # Implement here
  ddq = np.zeros(param.nbVarX) # Implement here
  u = inverse_dynamics(q, dq, ddq, param) 

  return u

print(state)
		</py-repl>
</div>
<div aria-labelledby="answer1-tab" class="tab-pane fade" id="answer1-tab-pane" role="tabpanel" tabindex="0">
<py-repl std-err="errors" std-out="output">
def controlCommand(state, param):
  # Question 1: Gravity Compensation Term (g(q))
  q = state[:param.nbVarX]
  u = inverse_dynamics(q, np.zeros(param.nbVarX), np.zeros(param.nbVarX), param)
  return u

</py-repl>
</div>
<div aria-labelledby="answer2-tab" class="tab-pane fade" id="answer2-tab-pane" role="tabpanel" tabindex="0">
<py-repl std-err="errors" std-out="output">
def controlCommand(state, param):
  # Question 2: Gravity compensation and Coriolis terms (c(q,dq) + g(q))
  q = state[:param.nbVarX]
  dq = state[param.nbVarX:]
  u = inverse_dynamics(q, dq, np.zeros(param.nbVarX), param)
  return u

</py-repl>
</div>
<div aria-labelledby="answer3-tab" class="tab-pane fade" id="answer3-tab-pane" role="tabpanel" tabindex="0">
<py-repl std-err="errors" std-out="output">
q_target = np.array([np.pi/2, 0])
dq_target = np.array([0, 0])
Kp = 30
Kv = 1
def controlCommand(state, param):
  # Question 3: Joint impedance control for reaching upright position
  q = state[:param.nbVarX]
  dq = state[param.nbVarX:]
  u = Kp * (q_target - q) + Kv * (dq_target - dq) + inverse_dynamics(q, dq, np.zeros(param.nbVarX), param)
  return u

</py-repl>
</div>
</div>
<br/><br/>
<!-- <p id='repl-out' style='font-size: 70%; color: #777777;'>(click on the green run button to run the code)</p>
<p id='repl-err' style='font-size: 70%; color: #880000;'></p> -->
</p></p></div> <!--sm-7-->
<div class="col-sm-4">
<div class="sticky-sm-top" style="padding: 2rem 1rem 1rem 1rem;">
<hr/>
<div class="row justify-content-between">
<div class="col-auto"><button class="btn btn-light btn-sm" disabled="">Output</button></div>
<div class="col-auto"><button class="btn btn-outline-secondary btn-sm float-right" onclick="clearMsgsOutput()">Clear</button></div>
</div>
<div id="output"></div>
<hr/>
<div class="row justify-content-between">
<div class="col-auto"><button class="btn btn-light btn-sm" disabled="">Error</button></div>
<div class="col-auto"><button class="btn btn-outline-secondary btn-sm float-right" onclick="clearMsgs()">Clear</button></div>
</div>
<div id="errors"></div>
<hr/>
<canvas height="1000px" id="canvas" style="width:100%;" width="900px"></canvas>
</div>
</div> <!--sm-4-->
</div> <!--row-->
<py-script>
    def print(x):
        display(x, target='output')
</py-script>
<py-script std-err="errors" std-out="output">
from pyodide.ffi import create_proxy
from js import Path2D, document, console
import numpy as np
import asyncio

def inverse_dynamics(q, dq, ddq, param):
	l = np.reshape(param.l, [1,param.nbVarX])
	m = np.reshape(param.l_m, [1,param.nbVarX])
	T = np.tril(np.ones([param.nbVarX, param.nbVarX]))
	Tm = np.multiply(np.triu(np.ones([m.shape[1], m.shape[1]])), np.repeat(m, m.shape[1],0))

	## Computation in matrix form of G,M, and C
	#G =-np.reshape(np.sum(Tm, 1), [param.nbVarX, 1]) * l.T * np.cos(T @ np.reshape(q, [param.nbVarX, 1])) * param.gravity
	#G = T.T @ G
	#M = (l.T * l) * np.cos(np.reshape(T @ q, [param.nbVarX, 1]) - T @ q) * (Tm**.5 @ ((Tm**.5).T))
	#M = T.T @ M @ T
	#C = -(l.T * l) * np.sin(np.reshape(T @ q, [param.nbVarX, 1]) - T @ q) * (Tm**.5 @ ((Tm**.5).T))

	# Elementwise computation of G, M, and C
	G = np.zeros([param.nbVarX, 1])
	M = np.zeros([param.nbVarX, param.nbVarX])
	C =  np.zeros([param.nbVarX, param.nbVarX])
	for k in range(param.nbVarX):
		G[k,0] = -sum(m[0,k:]) * param.gravity * l[0,k] * np.cos(T[k,:] @ q)
		for i in range(param.nbVarX):
			S = sum(m[0,k:param.nbVarX] * np.heaviside(np.array(range(k, param.nbVarX)) - i, 1))
			M[k,i] = l[0,k] * l[0,i] * np.cos(T[k,:] @ q - T[i,:] @ q) * S
			C[k,i] = -l[0,k] * l[0,i] * np.sin(T[k,:] @ q - T[i,:] @ q) * S

	G = T.T @ G
	M = T.T @ M @ T
	param.inertia_matrix = M
	return M @ ddq - T.T @ C @ (T @ dq)**2 - T @ dq * param.damping - G[:,0]


# Forward kinematics for end-effector (in robot coordinate system)
def fdyn(x,u, param):
	l = np.reshape(param.l, [1,param.nbVarX])
	m = np.reshape(param.l_m, [1,param.nbVarX])
	T = np.tril(np.ones([param.nbVarX, param.nbVarX]))
	Tm = np.multiply(np.triu(np.ones([m.shape[1], m.shape[1]])), np.repeat(m, m.shape[1],0))

	## Computation in matrix form of G,M, and C
	#G =-np.reshape(np.sum(Tm, 1), [param.nbVarX, 1]) * l.T * np.cos(T @ np.reshape(x[0:param.nbVarX], [param.nbVarX, 1])) * param.gravity
	#G = T.T @ G
	#M = (l.T * l) * np.cos(np.reshape(T @ x[:param.nbVarX], [param.nbVarX, 1]) - T @ x[:param.nbVarX]) * (Tm**.5 @ ((Tm**.5).T))
	#M = T.T @ M @ T
	#C = -(l.T * l) * np.sin(np.reshape(T @ x[:param.nbVarX], [param.nbVarX, 1]) - T @ x[:param.nbVarX]) * (Tm**.5 @ ((Tm**.5).T))

	# Elementwise computation of G, M, and C
	G = np.zeros([param.nbVarX, 1])
	M = np.zeros([param.nbVarX, param.nbVarX])
	C =  np.zeros([param.nbVarX, param.nbVarX])
	for k in range(param.nbVarX):
		G[k,0] = -sum(m[0,k:]) * param.gravity * l[0,k] * np.cos(T[k,:] @ x[:param.nbVarX])
		for i in range(param.nbVarX):
			S = sum(m[0,k:param.nbVarX] * np.heaviside(np.array(range(k, param.nbVarX)) - i, 1))
			M[k,i] = l[0,k] * l[0,i] * np.cos(T[k,:] @ x[:param.nbVarX] - T[i,:] @ x[:param.nbVarX]) * S
			C[k,i] = -l[0,k] * l[0,i] * np.sin(T[k,:] @ x[:param.nbVarX] - T[i,:] @ x[:param.nbVarX]) * S

	G = T.T @ G
	M = T.T @ M @ T
	param.inertia_matrix = M
	# Compute acceleration
	tau = np.reshape(u, [param.nbVarX, 1])
	inv_M = np.linalg.inv(M)
	ddq = inv_M @ (tau + G + T.T @ C @ (T @ np.reshape(x[param.nbVarX:],[param.nbVarX, 1]))**2 - \
		T @ np.reshape(x[param.nbVarX:],[param.nbVarX, 1])*param.damping)
	ddq = ddq[:, 0]
	# compute the next step
	dq = np.clip(x[param.nbVarX:] + ddq * param.dt , -10., 10.)
	q  = x[:param.nbVarX] + x[param.nbVarX:] * param.dt + 0.5 * ddq * (param.dt**2)
	xt = np.append(q, dq)
	return xt


# Forward kinematics for all joints (in robot coordinate system)
def fkin0(x, param):
	L = np.tril(np.ones([param.nbVarX, param.nbVarX]))
	f = np.vstack([
		L @ np.diag(param.l) @ np.cos(L @ x),
		L @ np.diag(param.l) @ np.sin(L @ x)
	])
	f = np.hstack([np.zeros([2,1]), f])
	return f

## Parameters
# ===============================

param = lambda: None # Lazy way to define an empty class in python
param.nbVarX = 2 # State space dimension (x1,x2,x3)
param.l = [2, 2] # Robot links lengths
param.l_m = [1, 1] # Link masses
param.damping = 8. # Damping
param.gravity = 9.81 # Gravity
param.dt = 5e-2 # Time step length
param.noise_scale = 0.


#########################################################################################

# Mouse events
mouse0 = np.zeros(2)
mousedown = 0
hover_joint = -1
move_joint= -1
hover0 = np.zeros(2)

def onMouseMove(event):
	global mouse, mouse0, hover0, x
	offset = canvas.getBoundingClientRect()
	mouse0[0] = (event.clientX - offset.x) * canvas.width / canvas.clientWidth
	mouse0[1] = (event.clientY - offset.y) * canvas.height / canvas.clientHeight
	if move_joint &gt;= 0:
		x[move_joint] -= 1E-2 * np.sum(hover0 - mouse0)
		hover0 = np.copy(mouse0)

def onTouchMove(event):
	global mouse, mouse0, hover0, x
	offset = event.target.getBoundingClientRect()
	mouse0[0] = (event.touches.item(0).clientX - offset.x) * canvas.width / canvas.clientWidth
	mouse0[1] = (event.touches.item(0).clientY - offset.y) * canvas.height / canvas.clientHeight
	if move_joint &gt;= 0:
		x[move_joint] -= 1E-2 * np.sum(hover0 - mouse0)
		hover0 = np.copy(mouse0)

def onMouseDown(event):
	global mousedown, move_joint, hover0
	mousedown = 1
	if hover_joint &gt;= 0:
		move_joint = hover_joint
		hover0 = np.copy(mouse0)

def onMouseUp(event):
	global mousedown, move_joint
	mousedown = 0
	move_joint = -1

def onWheel(event):
	global x
	if hover_joint &gt;= 0:
		x[hover_joint] -= 0.2 * (event.deltaY/106)

document.addEventListener('mousemove', create_proxy(onMouseMove)) #for standard mouse
document.addEventListener('touchmove', create_proxy(onTouchMove)) #for mobile interfaces

document.addEventListener('mousedown', create_proxy(onMouseDown)) #for standard mouse
#document.addEventListener('pointerdown', create_proxy(onMouseDown)) #for mobile interfaces
document.addEventListener('touchstart', create_proxy(onMouseDown)) #for mobile interfaces

document.addEventListener('mouseup', create_proxy(onMouseUp)) #for standard mouse
#document.addEventListener('pointerup', create_proxy(onMouseUp)) #for mobile interfaces
document.addEventListener('touchend', create_proxy(onMouseUp)) #for mobile interfaces

document.addEventListener('wheel', create_proxy(onWheel)) #for standard mouse


#########################################################################################

canvas = document.getElementById('canvas')
ctx = canvas.getContext('2d')

def clear_screen():
	ctx.setTransform(1, 0, 0, 1, 0, 0)
	ctx.fillStyle = 'white'
	ctx.fillRect(0, 0, canvas.width, canvas.height)


def draw_ground():
	ctx.setTransform(1, 0, 0, -1, canvas.width*0.5, canvas.height*0.9)
	ctx.translate(0, -40)
	ctx.lineCap = 'round'
	ctx.lineJoin = 'round'
	ctx.lineWidth = '5'
	ctx.strokeStyle = '#CCCCCC'
	ctx.beginPath()
	ctx.moveTo(-400, 0)
	ctx.lineTo(400, 0)
	ctx.stroke()


def draw_robot(x, color):
	global hover_joint
	ctx.setTransform(1, 0, 0, -1, canvas.width*0.5, canvas.height*0.5)

	f = fkin0(x, param)*100

	# Draw base
	ctx.translate(f[0,0], f[1,0])
	ctx.lineWidth = '4'
	ctx.strokeStyle = 'white'
	ctx.fillStyle = color
	ctx.beginPath()
	ctx.arc(0, 0, 40, 0, np.pi)
	ctx.rect(-40, 0, 80, -40)
	ctx.fill()
	ctx.strokeStyle = color
	for i in range(5):
		ctx.beginPath()
		ctx.moveTo(-30+i*15, -40)
		ctx.lineTo(-40+i*15, -60)
		ctx.stroke()

	# Draw links
	ctx.lineCap = 'round'
	ctx.lineJoin = 'round'
	for i in range(param.nbVarX):
		# Draw links outlines
		ctx.lineWidth = '46'
		ctx.strokeStyle = 'white'
		ctx.beginPath()
		ctx.lineTo(f[0,i], f[1,i])
		ctx.lineTo(f[0,i+1], f[1,i+1])
		ctx.stroke()
		# Draw links
		ctx.lineWidth = '38'
		ctx.strokeStyle = color
		ctx.beginPath()
		ctx.lineTo(f[0,i], f[1,i])
		ctx.lineTo(f[0,i+1], f[1,i+1])
		ctx.stroke()

	# Draw articulations
	obj = Path2D.new()
	obj.arc(0, 0, 12, 0, 2*np.pi)
	ctx.lineWidth = '4'
	ctx.strokeStyle = 'white'
	for i in range(param.nbVarX+1):
		ctx.translate(f[0,i], f[1,i])
		ctx.stroke(obj)
		if ctx.isPointInPath(obj, mouse0[0], mouse0[1]):
			hover_joint = i
		ctx.translate(-f[0,i], -f[1,i])


def draw_tip(f, color):
	ctx.setTransform(1, 0, 0, -1, canvas.width*0.5, canvas.height*0.9)
	# Draw object
	obj = Path2D.new()
	obj.arc(0, 0, 16, 0, 2*np.pi)
	ctx.translate(f[0], f[1])
	ctx.fillStyle = color
	ctx.fill(obj)


def controlCommand(state, param):
	u = inverse_dynamics(q=state[:param.nbVarX], dq=np.zeros(param.nbVarX), ddq=np.zeros(param.nbVarX), param) # Gravity compensation
	return u

#########################################################################################

def errorHandler(e):
	msg = 'Error: ' + str(e)
	console.error(msg)
	el = document.getElementById('errors')
	el.innerText = msg
	#el.textContent = msg

#########################################################################################
x = np.array([-np.pi/3, np.pi/4]) # Initial robot state
x_target = np.array([np.pi/2, np.pi/5])
state = np.append(x, np.zeros(param.nbVarX))
u = np.zeros(param.nbVarX)

async def main():
	global hover_joint, x, state

	while True:
		try:
			u = controlCommand(state+np.random.randn(param.nbVarX*2)*param.noise_scale, param)
		except Exception as e:
			errorHandler(e)
			u = np.zeros(param.nbVarX)

		state = fdyn(state, u, param)
		x = state[:param.nbVarX]
		# Reinit hovering variables
		hover_joint = -1

		# Rendering
		clear_screen()
	#	draw_ground()
		draw_robot(x, '#AAAAAA')
		#draw_tip(f, '#FF3399')

		await asyncio.sleep(0.01)

pyscript.run_until_complete(main())

</py-script>
</div> <!--container-->
</body>
</html>
