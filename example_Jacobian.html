<!DOCTYPE html>

<html lang="en">
<head>


<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="RCFS" name="description"/>
<meta content="robotics codes, robotics tutorial, rcfs, robotics from scratch" name="keywords"/>
<meta content="Sylvain Calinon" name="author"/>
<title>RCFS</title>
<link href="static_images/favicon.ico" rel="icon" sizes="any"/>
<link href="static_images/favicon.svg" rel="icon" type="image/svg+xml"/>

<link href="css/bootstrap.min.css" rel="stylesheet"/>
<link href="css/bootstrap-icons-1.10.4/font/bootstrap-icons.css" rel="stylesheet"/>
<link href="css/permanent_marker.css" rel="stylesheet"/>
<link href="css/sidebars.css" rel="stylesheet"/>
<script src="js/jquery-3.6.4.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>

<script defer="" src="https://pyscript.net/latest/pyscript.min.js"></script>
<py-config type="toml">

				packages = ['numpy']
			
</py-config>
<link href="https://pyscript.net/latest/pyscript.css" rel="stylesheet"/> <!-- pyscript.css is incompatible with hypothes.is/embed.js-->

<link href="css/katex.min.css" rel="stylesheet"/>
<script src="js/katex.min.js"></script>
<script defer="" src="js/katex-auto-render.js"></script>
<script>
        const macros = {
            '\\tp': '\\text{\\tiny{#1}}',
            '\\trsp' : '\\top',
            '\\psin' : '\\dagger',
            '\\eqref': '\\href{###1}{(\\text{#1})}',
            '\\ref': '\\href{###1}{\\text{#1}}',
            '\\label': '\\htmlId{#1}{}'
        };

        function initialize(){
            convertMath();
        }

        function convertMath(){
            const elements = document.getElementsByClassName("ltx_Math");
            for(let element of elements){
                katex.render(element.textContent, element, {
                    throwOnError: false,
                    macros
                });
            }
        }

        window.onload = initialize;

        document.addEventListener('DOMContentLoaded', function() {
            renderMathInElement(document.body, {
                // customised options
                trust: (context) => ['\\htmlId', '\\href'].includes(context.command),
                macros: macros,
                // • auto-render specific keys, e.g.:
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\begin{equation}', right: '\\end{equation}', display: true},
                    {left: '\\begin{equation*}', right: '\\end{equation*}', display: true},
                    {left: '\\begin{align}', right: '\\end{align}', display: true},
                    {left: '\\begin{align*}', right: '\\end{align*}', display: true},
                    {left: '\\begin{alignat}', right: '\\end{alignat}', display: true},
                    {left: '\\begin{gather}', right: '\\end{gather}', display: true},
                    {left: '\\begin{CD}', right: '\\end{CD}', display: true},
                    {left: '\\[', right: '\\]', display: true}
                ],
                // • rendering keys, e.g.:
                throwOnError : false
            });
        });
    </script>

<link href="css/main-template.css" rel="stylesheet"/>
</head>
<body><nav aria-label="Light offcanvas navbar" class="navbar fixed-top" style="width: 50px;">
<div class="container-fluid">
<button aria-controls="offcanvasNavbarLight" class="navbar-toggler" data-bs-target="#offcanvasNavbarLight" data-bs-toggle="offcanvas" type="button">
<span class="navbar-toggler-icon" style="cursor: pointer;"></span>
</button>
<div aria-labelledby="offcanvasNavbarLightLabel" class="offcanvas offcanvas-start" id="offcanvasNavbarLight" style="width: 500px;" tabindex="-1">
<div class="offcanvas-header"><!--style='height: 50px;'-->
<a class="navbar-brand" href="index.html"><h4 class="offcanvas-title" id="offcanvasNavbarLightLabel"> <i class="bi bi-code-slash"></i> RCFS</h4></a>
<button aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button"></button>
</div>
<div class="offcanvas-body">
<!--Menu goes here-->
<ul class="list-unstyled ps-0">
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="true" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#general-collapse" data-bs-toggle="collapse">General information</button>
<div class="collapse show" id="general-collapse">
<!--<li><a href='index.html' class='link-dark d-inline-flex text-decoration-none rounded'>Home</a></li>-->
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="about.html">
<div class="p-1 mb-0">About</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#sandboxes2d-collapse" data-bs-toggle="collapse">2D sandboxes</button>
<div class="collapse" id="sandboxes2d-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_FK.html">
<div class="p-1 mb-0">Forward kinematics (FK)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_IK.html">
<div class="p-1 mb-0">Inverse kinematics (IK)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_bimanual.html">
<div class="p-1 mb-0">Bimanual robot</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_humanoid.html">
<div class="p-1 mb-0">Humanoid robot (CoM and coordination matrix)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR.html">
<div class="p-1 mb-0">Iterative linear quadratic regulator (iLQR)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR_car.html">
<div class="p-1 mb-0">iLQR for car</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_iLQR_bicopter.html">
<div class="p-1 mb-0">iLQR for bicopter</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox_impedance.html">
<div class="p-1 mb-0">Impedance control</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#sandboxes3d-collapse" data-bs-toggle="collapse">3D sandboxes</button>
<div class="collapse" id="sandboxes3d-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="sandbox3d_IK.html">
<div class="p-1 mb-0">Inverse kinematics (IK)</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#exercises-collapse" data-bs-toggle="collapse">Coding exercises</button>
<div class="collapse" id="exercises-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise01.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">01</div>
<div class="p-1 mb-0">Linear algebra in Python</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise02.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">02</div>
<div class="p-1 mb-0">Movement primitives and Newton's method</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise03.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">03</div>
<div class="p-1 mb-0">Gaussian Distributions</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise04a.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">4a</div>
<div class="p-1 mb-0">Forward kinematics</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise04b.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">4b</div>
<div class="p-1 mb-0">Inverse kinematics and nullspace control</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise05a.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">5a</div>
<div class="p-1 mb-0">Forward dynamics</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise05b.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">5b</div>
<div class="p-1 mb-0">Inverse dynamics and impedance control</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise06a.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">6a</div>
<div class="p-1 mb-0">Planning with linear quadratic regulator</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise06b.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">6b</div>
<div class="p-1 mb-0">Planning in joint space with LQR</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise07.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">07</div>
<div class="p-1 mb-0">Iterative linear quadratic regulator (iLQR)</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise08.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">08</div>
<div class="p-1 mb-0">Exploration with ergodic control</div></a></li>
<li><a class="link-dark d-inline-flex text-decoration-none rounded" href="exercise09.html">
<div class="p-1 mb-0 bg-dark text-white font-monospace">09</div>
<div class="p-1 mb-0">Orientation with Riemannian manifold</div></a></li>
</ul>
</div>
</li>
<li class="border-top my-1"></li>
<li class="mb-1">
<button aria-expanded="false" class="btn btn-toggle d-inline-flex align-items-center rounded border-0 collapsed" data-bs-target="#doc-collapse" data-bs-toggle="collapse">Online course</button>
<div class="collapse" id="doc-collapse">
<ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small" id="menu_container">
<li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="toc.html" style="font-weight:bold;">Table of contents</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S1.html" style="font-weight:bold;">1 Introduction</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html" style="font-weight:bold;">2 Newton’s method for minimization</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:GaussNewton"><span class="p-1 mb-0">2.1 Gauss–Newton algorithm</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:LS"><span class="p-1 mb-0">2.2 Least squares</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S2.html#sec:LSconstraints"><span class="p-1 mb-0">2.3 Least squares with constraints</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S3.html" style="font-weight:bold;">3 Forward kinematics (FK) for a planar robot manipulator</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html" style="font-weight:bold;">4 Inverse kinematics (IK) for a planar robot manipulator</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html#sec:IKnum"><span class="p-1 mb-0">4.1 Numerical estimation of the Jacobian</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S4.html#sec:IK_nullspace"><span class="p-1 mb-0">4.2 Inverse kinematics (IK) with task prioritization</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html" style="font-weight:bold;">5 Encoding with basis functions</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS1"><span class="p-1 mb-0">5.1 Univariate trajectories</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS2"><span class="p-1 mb-0">5.2 Multivariate trajectories</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS3"><span class="p-1 mb-0">5.3 Multidimensional inputs</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS4"><span class="p-1 mb-0">5.4 Derivatives</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS5"><span class="p-1 mb-0">5.5 Concatenated basis functions</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS6"><span class="p-1 mb-0">5.6 Batch computation of basis functions coefficients</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S5.html#SS7"><span class="p-1 mb-0">5.7 Recursive computation of basis functions coefficients</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html" style="font-weight:bold;">6 Linear quadratic tracking (LQT)</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#SS1"><span class="p-1 mb-0">6.1 LQT with smoothness cost</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#SS2"><span class="p-1 mb-0">6.2 LQT with control primitives</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:LQRrecursive"><span class="p-1 mb-0">6.3 LQR with a recursive formulation</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:augmState"><span class="p-1 mb-0">6.4 LQT with a recursive formulation and an augmented state space</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:LQRLS"><span class="p-1 mb-0">6.5 Least squares formulation of recursive LQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S6.html#sec:DMPLQT"><span class="p-1 mb-0">6.6 Dynamical movement primitives (DMP) reformulated as LQT with control primitives</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html" style="font-weight:bold;">7 iLQR optimization</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRbatch"><span class="p-1 mb-0">7.1 Batch formulation of iLQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRrecursive"><span class="p-1 mb-0">7.2 Recursive formulation of iLQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#sec:iLQRLS"><span class="p-1 mb-0">7.3 Least squares formulation of recursive iLQR</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS4"><span class="p-1 mb-0">7.4 Updates by considering step sizes</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS5"><span class="p-1 mb-0">7.5 iLQR with quadratic cost on f(x_{t})</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS6"><span class="p-1 mb-0">7.6 iLQR with control primitives</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS7"><span class="p-1 mb-0">7.7 iLQR for spacetime optimization</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS8"><span class="p-1 mb-0">7.8 iLQR with offdiagonal elements in the precision matrix</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS9"><span class="p-1 mb-0">7.9 Car steering</span></a></li><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S7.html#SS10"><span class="p-1 mb-0">7.10 Bicopter</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="S8.html" style="font-weight:bold;">8 Forward dynamics (FD) for a planar robot manipulator</a><div><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="link-dark d-inline-flex text-decoration-none rounded" href="S8.html#SS1"><span class="p-1 mb-0">8.1 Robot manipulator with dynamics equation</span></a></li></ul></div></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="bib.html" style="font-weight:bold;">References</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A1.html" style="font-weight:bold;">A System dynamics at trajectory level</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A2.html" style="font-weight:bold;">B Derivation of motion equation for a planar robot</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A3.html" style="font-weight:bold;">C Linear systems used in the bimanual tennis serve example</a></li><li class="mb-1 generated-menu-item"><a class="link-dark d-inline-flex text-decoration-none rounded" href="A4.html" style="font-weight:bold;">D Equivalence between LQT and LQR with augmented state space</a></li></ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</nav>
<div class="container-fluid">
<script>
function clearMsgs() {
  const el = document.getElementById('repl-err');
  el.innerText = '';
  //console.log('event!');
}
</script>
<div class="row">
<div class="col-sm-1"></div>
<div class="col-sm-7">
<br/><br/><br/><br/><br/><br/>
<div align="right" style="font-size: 200%;">
<div class="ltx_Math" id="formula0">
\bm{J}(\bm{x})=\begin{bmatrix}
\frac{\color{#00AA00}\partial f_1}{\color{#CC0000}\partial x_1} &amp;
{\color{#CCCCCC}\frac{\partial f_1}{\partial x_2}} &amp;
{\color{#CCCCCC}\frac{\partial f_1}{\partial x_3}}
\\[2mm]
\frac{\color{#0000CC}\partial f_2}{\color{#CC0000}\partial x_1} &amp;
{\color{#CCCCCC}\frac{\partial f_2}{\partial x_2}} &amp;
{\color{#CCCCCC}\frac{\partial f_2}{\partial x_3}}
\end{bmatrix}
</div>
<div class="ltx_Math" hidden="hidden" id="formula1">
\bm{J}(\bm{x})=\begin{bmatrix}
{\color{#CCCCCC}\frac{\partial f_1}{\partial x_1}} &amp;
\frac{\color{#00AA00}\partial f_1}{\color{#CC5500}\partial x_2} &amp;
{\color{#CCCCCC}\frac{\partial f_1}{\partial x_3}}
\\[2mm]
{\color{#CCCCCC}\frac{\partial f_2}{\partial x_1}} &amp;
\frac{\color{#0000CC}\partial f_2}{\color{#CC5500}\partial x_2} &amp;
{\color{#CCCCCC}\frac{\partial f_2}{\partial x_3}}
\end{bmatrix}
</div>
<div class="ltx_Math" hidden="hidden" id="formula2">
\bm{J}(\bm{x})=\begin{bmatrix}
{\color{#CCCCCC}\frac{\partial f_1}{\partial x_1}} &amp;
{\color{#CCCCCC}\frac{\partial f_1}{\partial x_2}} &amp;
\frac{\color{#00AA00}\partial f_1}{\color{#CC9900}\partial x_3}
\\[2mm]
{\color{#CCCCCC}\frac{\partial f_2}{\partial x_1}} &amp;
{\color{#CCCCCC}\frac{\partial f_2}{\partial x_2}} &amp;
\frac{\color{#0000CC}\partial f_2}{\color{#CC9900}\partial x_3}
\end{bmatrix}
</div>
</div> <!--align-->
</div> <!--sm-7-->
<div class="col-sm-4">
<div class="sticky-sm-top">
<div style="position:relative; font-size: 150%;">
<canvas height="700px" id="canvas" style="width:100%;" width="900px"></canvas>
<span class="ltx_Math" id="x0" style="position:absolute; left:9999px; bottom:0px;">\color{#CC0000}x_1</span>
<span class="ltx_Math" id="x1" style="position:absolute; left:9999px; bottom:0px;">\color{#CC5500}x_2</span>
<span class="ltx_Math" id="x2" style="position:absolute; left:9999px; bottom:0px;">\color{#CC9900}x_3</span>
<span class="ltx_Math" id="f0" style="position:absolute; left:9999px; bottom:0px;">\color{#00AA00}f_1</span>
<span class="ltx_Math" id="f1" style="position:absolute; left:9999px; bottom:0px;">\color{#0000CC}f_2</span>
</div>
</div> <!--sticky-sm-top-->
</div> <!--sm-4-->
</div> <!--row-->
<py-script>
from pyodide.ffi import create_proxy
from js import Path2D, document, console
import numpy as np
import asyncio

# Forward kinematics for end-effector (in robot coordinate system)
def fkin(x, param):
	L = np.tril(np.ones([param.nbVarX, param.nbVarX]))
	f = [param.l @ np.cos(L @ x), param.l @ np.sin(L @ x)]
	return f

# Forward kinematics for all joints (in robot coordinate system)
def fkin0(x, param):
	L = np.tril(np.ones([param.nbVarX, param.nbVarX]))
	f = np.vstack([
		L @ np.diag(param.l) @ np.cos(L @ x),
		L @ np.diag(param.l) @ np.sin(L @ x)
	])
	f = np.hstack([np.zeros([2,1]), f])
	return f

# Jacobian with analytical computation (for single time step)
def Jkin(x, param):
	L = np.tril(np.ones([param.nbVarX, param.nbVarX]))
	J = np.vstack([
		-np.sin(L @ x).T @ np.diag(param.l) @ L,
		 np.cos(L @ x).T @ np.diag(param.l) @ L
	])
	return J

## Parameters
# ===============================

param = lambda: None # Lazy way to define an empty class in python
param.dt = 1E-1 # Time step length
param.nbVarX = 3 # State space dimension (x1,x2,x3)
param.l = [320, 280, 160] # Robot links lengths

param2 = lambda: None # Lazy way to define an empty class in python

#########################################################################################

# Mouse events
mouse0 = np.zeros(2)
mouse = np.zeros(2)
mousedown = 0
hover_joint = -1
move_joint= -1

def onMouseMove(event):
	global mouse, mouse0
	offset = canvas.getBoundingClientRect()
	mouse0[0] = (event.clientX - offset.x) * canvas.width / canvas.clientWidth
	mouse0[1] = (event.clientY - offset.y) * canvas.height / canvas.clientHeight
	mouse[0] = (mouse0[0] - canvas.width * 0.2)
	mouse[1] = -(mouse0[1] - canvas.height * 0.9)

def onTouchMove(event):
	global mouse, mouse0
	offset = event.target.getBoundingClientRect()
	mouse0[0] = (event.touches.item(0).clientX - offset.x) * canvas.width / canvas.clientWidth
	mouse0[1] = (event.touches.item(0).clientY - offset.y) * canvas.height / canvas.clientHeight
	mouse[0] = (mouse0[0] - canvas.width * 0.2)
	mouse[1] = -(mouse0[1] - canvas.height * 0.9)

def onMouseDown(event):
	global mousedown, move_joint, param2, formula_el
	mousedown = 1
#	if hover_joint &gt;= 0:
#		f0 = fkin0(x, param)
#		param2.l = np.append(param.l[:hover_joint], np.linalg.norm(f0[:,hover_joint] - mouse))
#		param2.nbVarX = hover_joint+1
#		move_joint = hover_joint
#		for i in range(param.nbVarX):
#			formula_el[i].setAttribute('hidden', 'hidden')
#		formula_el[hover_joint].removeAttribute('hidden')

def onMouseUp(event):
	global mousedown, move_joint
	mousedown = 0
	move_joint = -1

def onWheel(event):
	global x
#	if hover_joint &gt;= 0:
#		x[hover_joint] -= 0.2 * (event.deltaY/106)

document.addEventListener('mousemove', create_proxy(onMouseMove)) #for standard mouse
document.addEventListener('touchmove', create_proxy(onTouchMove)) #for mobile interfaces

document.addEventListener('mousedown', create_proxy(onMouseDown)) #for standard mouse
#document.addEventListener('pointerdown', create_proxy(onMouseDown)) #for mobile interfaces
document.addEventListener('touchstart', create_proxy(onMouseDown)) #for mobile interfaces

document.addEventListener('mouseup', create_proxy(onMouseUp)) #for standard mouse
#document.addEventListener('pointerup', create_proxy(onMouseUp)) #for mobile interfaces
document.addEventListener('touchend', create_proxy(onMouseUp)) #for mobile interfaces

document.addEventListener('wheel', create_proxy(onWheel)) #for standard mouse

#########################################################################################

canvas = document.getElementById('canvas')
ctx = canvas.getContext('2d')

x_el = []
formula_el = []
for i in range(param.nbVarX):
	formula_el.append(document.getElementById('formula%d' % i))
	x_el.append(document.getElementById('x%d' % i))
f_el = [document.getElementById('f0'), document.getElementById('f1')]


def clear_screen():
	ctx.setTransform(1, 0, 0, 1, 0, 0)
	ctx.fillStyle = 'white'
	ctx.fillRect(0, 0, canvas.width, canvas.height)
	ctx.setTransform(1, 0, 0, -1, canvas.width*0.2, canvas.height*0.9)


def draw_robot(x):
	global hover_joint, x_el
	f = fkin0(x, param)

	# Draw axes
	ctx.lineWidth = '2'
	ctx.fillStyle = '#DDDDDD'
	ctx.strokeStyle = '#DDDDDD'
	ctx.beginPath()
	ctx.moveTo(650,0)
	ctx.lineTo(0,0)
	ctx.lineTo(0,500)
	ctx.stroke()
	# Draw arrow tips
	ctx.beginPath()
	ctx.moveTo(650,0)
	ctx.lineTo(630,-10)
	ctx.lineTo(630,10)
	ctx.fill()
	ctx.beginPath()
	ctx.moveTo(0,500)
	ctx.lineTo(-10,480)
	ctx.lineTo(10,480)
	ctx.fill()

	# Draw base
	ctx.translate(f[0,0], f[1,0])
	ctx.lineWidth = '4'
	ctx.strokeStyle = 'white'
	ctx.fillStyle = '#AAAAAA'
	ctx.beginPath()
	ctx.arc(0, 0, 40, 0, np.pi)
	ctx.rect(-40, 0, 80, -40)
	ctx.fill()
	ctx.strokeStyle = '#AAAAAA'
	for i in range(5):
		ctx.beginPath()
		ctx.moveTo(-30+i*15, -40)
		ctx.lineTo(-40+i*15, -60)
		ctx.stroke()

	# Draw links and articulations
	obj_articulation = Path2D.new()
	obj_articulation.arc(0, 0, 12, 0, 2*np.pi)
	ctx.lineCap = 'round'
	ctx.lineJoin = 'round'
	for i in range(param.nbVarX):
		if i &lt; param.nbVarX:
			# Draw links outlines
			ctx.lineWidth = '46'
			ctx.strokeStyle = 'white'
			ctx.beginPath()
			ctx.lineTo(f[0,i], f[1,i])
			ctx.lineTo(f[0,i+1], f[1,i+1])
			ctx.stroke()
			# Draw links
			obj = Path2D.new()
			obj.lineTo(f[0,i], f[1,i])
			obj.lineTo(f[0,i+1], f[1,i+1])
			ctx.lineWidth = '38'
			ctx.strokeStyle = '#AAAAAA'
			ctx.stroke(obj)
			if ctx.isPointInStroke(obj, mouse0[0], mouse0[1]) and move_joint &lt; 0:
				hover_joint = i
		# Draw articulations
		ctx.lineWidth = '4'
		ctx.strokeStyle = 'white'
		ctx.translate(f[0,i], f[1,i])
		ctx.stroke(obj_articulation)
		ctx.translate(-f[0,i], -f[1,i])

#	# Draw link lengths
#	ctx.font = '38px serif'
#	ctx.fillStyle = 'rgb(0, 160, 0)'
#	ctx.strokeStyle = 'rgb(0, 160, 0)'
#	ctx.setLineDash([2, 6])
#	for i in range(param.nbVarX):
#		ctx.beginPath()
#		ctx.moveTo(f[0,i], f[1,i])
#		ctx.lineTo(f[0,i+1], f[1,i+1])
#		ctx.stroke()
#		ctx.save()
#		xtmp = [np.mean([f[0,i], f[0,i+1]]), np.mean([f[1,i], f[1,i+1]])]
#		dtmp = f[:,i+1] - f[:,i]
#		dtmp = [dtmp[1], -dtmp[0]] / np.linalg.norm(dtmp)
#		ctx.translate(xtmp[0]+dtmp[0]*30-15, xtmp[1]+dtmp[1]*30-15)
#		ctx.scale(1, -1)
#		ctx.fillText('l' + chr(8321 + i), 0, 0) # Display subscript with unicode
#		ctx.restore()

	# Draw joint angles
	ctx.setLineDash([])
	colors = ['#CC0000','#CC5500','#CC9900']
	colors2 = ['#CC000033','#CC550033','#CC990033']
	r = 80
	ctx.font = '48px serif'
	ctx.setLineDash([2, 6])
	for i in range(param.nbVarX):
		a = np.sort([np.sum(x[:i]), np.sum(x[:(i+1)])])
		ctx.translate(f[0,i], f[1,i])
		# Draw sector
		ctx.fillStyle = colors2[i]
		ctx.beginPath()
		ctx.moveTo(0, 0)
		ctx.arc(0, 0, r*.9, a[0], a[1])
		ctx.lineTo(0, 0)
		ctx.fill()
		# Draw sector boundaries
		ctx.strokeStyle = colors[i]
		ctx.beginPath()
		ctx.moveTo(0, 0)
		ctx.lineTo(np.cos(a[0])*r, np.sin(a[0])*r)
		ctx.stroke()
		ctx.beginPath()
		ctx.moveTo(0, 0)
		ctx.lineTo(np.cos(a[1])*r, np.sin(a[1])*r)
		ctx.stroke()

#		# Draw joint angle name (with canvas)
#		ctx.fillStyle = colors[i]
#		ctx.save()
#		ctx.translate(np.cos(np.mean(a))*(r+20)-15, np.sin(np.mean(a))*(r+20)-15)
#		ctx.scale(1, -1)
#		ctx.fillText('x' + chr(8321 + i), 0, 0) # Display subscript with unicode
#		ctx.restore()

		# Draw joint angle name (with latex)
		xtmp = np.zeros(2)
		xtmp[0] = (f[0,i] + np.cos(np.mean(a))*(r+20)-15 + canvas.width * 0.2) * canvas.clientWidth / canvas.width
		xtmp[1] = (f[1,i] + np.sin(np.mean(a))*(r+20)-15 + canvas.height * 0.1) * canvas.clientHeight / canvas.height
		x_el[i].setAttribute('style', 'position:absolute; left:%dpx; bottom:%dpx;' % (xtmp[0],xtmp[1]))

		ctx.translate(-f[0,i], -f[1,i])

	# Draw robot end-effector
	ctx.setLineDash([])
	obj = Path2D.new()
	obj.arc(0, 0, 6, 0, 2*np.pi)
	ctx.fillStyle = 'rgb(0, 0, 0)'
	ctx.translate(f[0,-1], 0)
	ctx.fill(obj)
	ctx.translate(0, f[1,-1])
	ctx.fill(obj)
	ctx.translate(-f[0,-1], 0)
	ctx.fill(obj)
	ctx.translate(0, -f[1,-1])


def draw_trace(fhist):
	# Draw trace
	ctx.lineWidth = '8'
	ctx.strokeStyle = '#555555'
	ctx.beginPath()
	for i in range(fhist_id+1, fhist.shape[1]):
		ctx.lineTo(fhist[0,i], fhist[1,i])
	for i in range(fhist_id):
		ctx.lineTo(fhist[0,i], fhist[1,i])
	ctx.stroke()
	# Draw trace on horizontal axis
	ctx.strokeStyle = '#00AA00'
	ctx.fillStyle = '#00AA00'
	ctx.beginPath()
	for i in range(fhist_id+1, fhist.shape[1]):
		ctx.lineTo(fhist[0,i], 0)
	for i in range(fhist_id):
		ctx.lineTo(fhist[0,i], 0)
	ctx.stroke()

#	# Draw text on horizontal axis
#	ctx.save()
#	ctx.translate(fhist[0,fhist_id-1]-15, -45)
#	ctx.scale(1, -1)
#	ctx.fillText('f' + chr(8321), 0, 0) # Display subscript with unicode
#	ctx.restore()

	# Draw trace on vertical axis
	ctx.strokeStyle = '#0000CC'
	ctx.fillStyle = '#0000CC'
	ctx.beginPath()
	for i in range(fhist_id+1, fhist.shape[1]):
		ctx.lineTo(0, fhist[1,i])
	for i in range(fhist_id):
		ctx.lineTo(0, fhist[1,i])
	ctx.stroke()

#	# Draw text on vertical axis (with canvas)
#	ctx.save()
#	ctx.translate(-45, fhist[1,fhist_id-1]-15)
#	ctx.scale(1, -1)
#	ctx.fillText('f' + chr(8322), 0, 0) # Display subscript with unicode
#	ctx.restore()

	# Draw text on axes (with latex)
	xtmp = np.zeros(2)
	xtmp[0] = (fhist[0,fhist_id-1] - 15 + canvas.width * 0.2) * canvas.clientWidth / canvas.width
	xtmp[1] = (- 60 + canvas.height * 0.1) * canvas.clientHeight / canvas.height
	f_el[0].setAttribute('style', 'position:absolute; left:%dpx; bottom:%dpx;' % (xtmp[0],xtmp[1])) # Horizontal axis
	xtmp[0] = (- 60 + canvas.width * 0.2) * canvas.clientWidth / canvas.width
	xtmp[1] = (fhist[1,fhist_id-1] - 15 + canvas.height * 0.1) * canvas.clientHeight / canvas.height
	f_el[1].setAttribute('style', 'position:absolute; left:%dpx; bottom:%dpx;' % (xtmp[0],xtmp[1])) # Vertical axis


def draw_selected_point(f):
	obj = Path2D.new()
	obj.arc(0, 0, 6, 0, 2*np.pi)
	ctx.translate(f[0], f[1])
	ctx.fillStyle = '#999999'
	ctx.fill(obj)
	ctx.translate(-f[0], -f[1])


def errorHandler(e):
	msg = 'Error: ' + str(e)
	console.error(msg)
	el = document.getElementById('repl-err')
	el.innerText = msg
	#el.textContent = msg


def controlCommand(x, param):
	u = np.zeros(param.nbVarX)
	if move_joint &gt;= 0:
		# Residual and Jacobian
		df = (mouse - fkin(x[:move_joint+1], param2)) * 5
		J = Jkin(x[:move_joint+1], param2)
		J = np.hstack((J, np.zeros([2,param.nbVarX-move_joint-1]))) # Augmented form
		# IK
		pinvJ = np.linalg.inv(J.T @ J + np.eye(J.shape[1]) * 1e4) @ J.T # Damped pseudoinverse
		u = pinvJ @ df # Control commands
	return u


def wiggleJoint(joint_id, t):
	u = np.zeros(param.nbVarX)
	u[joint_id] = np.sin(np.pi * 4 * t / tmax) * .08
	return u

#########################################################################################
x = [np.pi/3, -np.pi/4, -np.pi/2] # Initial robot state
fhist = np.tile(np.array(fkin(x,param)).reshape(-1,1), [1,100])
fhist_id = 0
joint_id = 0
t = 0
tmax = 200

async def main():
	global hover_joint, x, fhist, fhist_id, t, joint_id, formula_el

	while True:
		# u = controlCommand(x, param)
		u = wiggleJoint(joint_id, t)
		x += u * param.dt # Update robot state
		f = fkin(x, param)
		fhist[:,fhist_id] = f
		fhist_id = (fhist_id+1) % 100

		t += 1
		if t &gt; tmax:
			t = 0
			joint_id = (joint_id+1) % param.nbVarX
			fhist = np.tile(np.array(fkin(x,param)).reshape(-1,1), [1,100])
			for i in range(param.nbVarX):
				formula_el[i].setAttribute('hidden', 'hidden')
			formula_el[joint_id].removeAttribute('hidden')

#		# Reinit hovering variables
#		hover_joint = -1

		# Rendering
		clear_screen()
		draw_robot(x)
		draw_trace(fhist)
#		if move_joint &gt;= 0:
#			f = fkin(x[:move_joint+1], param2)
#			draw_selected_point(f)

		await asyncio.sleep(0.0001)

pyscript.run_until_complete(main())

</py-script>
</div> <!--container-->
</body>
</html>
